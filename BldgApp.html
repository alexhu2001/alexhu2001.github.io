<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Energy Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
  <h1 id="title">Monthly Usage</h1>

  <label for="homeSelect">Select Home:</label>
  <select id="homeSelect"></select>

  <div id="chart"></div>
  <div id="msg" style="color:red;"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    let bldg = params.get("bldg") || "7352";

    function parseHeaderDate(s) {
      const parts = s.split("/");
      if (parts.length === 3) {
        const [m, d, y] = parts.map(p => parseInt(p, 10));
        return new Date(y, m - 1, d);
      }
      return new Date(s);
    }

    d3.csv("DataSummary.csv").then(function(data) {
      const headers = data.columns;
      const dateCols = headers.slice(1);
      
      // Compute average across all homes and all months
      let allValues = [];
      data.forEach(row => {
        dateCols.forEach(col => {
          const val = row[col];
          if (val && val.trim() !== "") {
            allValues.push(+val);
          }
        });
      });
      const avgAllHomes = d3.mean(allValues);
      
      // Populate dropdown
      const selectEl = document.getElementById("homeSelect");
      data.forEach(row => {
        const id = row["dataid/date"];
        if (id) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = id;
          selectEl.appendChild(opt);
        }
      });
      selectEl.value = bldg;

      function drawChart(homeId) {
        const row = data.find(d => String(d["dataid/date"]).trim() === String(homeId));
        if (!row) {
          document.getElementById("msg").innerText = "No data for " + homeId;
          return;
        }

        const x = [], y = [];
        dateCols.forEach(col => {
          const val = row[col];
          if (val && val.trim() !== "") {
            x.push(parseHeaderDate(col));
            y.push(+val);
          }
        });

        if (x.length === 0) {
          document.getElementById("msg").innerText = "No values found for " + homeId;
          return;
        }

        const maxVal = Math.max(...y);
        const yMax = maxVal * 1.2;

        Plotly.newPlot("chart", [{
          x: x,
          y: y,
          type: "scatter",
          mode: "lines+markers",
          name: "kWh"
        }], {
          title: "Monthly Consumption for Home " + homeId,
          xaxis: { title: "Month", type: "date" },
          yaxis: { title: "kWh", range: [0, yMax] },
          shapes: [
            {
              type: "line",
              x0: Math.min(...x),
              x1: Math.max(...x),
              y0: avgAllHomes,
              y1: avgAllHomes,
              line: { color: "red", dash: "dot" }
            }
          ]
        });
        
        document.getElementById("title").innerText = "Monthly Usage for Home " + homeId;
        document.getElementById("msg").innerText = "";
      }

      // Initial draw
      drawChart(bldg);

      // Dropdown change
      selectEl.addEventListener("change", () => {
        const newId = selectEl.value;
        const url = new URL(window.location);
        url.searchParams.set("bldg", newId);
        window.history.replaceState({}, "", url);
        drawChart(newId);
      });
    }).catch(err => {
      document.getElementById("msg").innerText = "Error loading CSV: " + err;
      console.error(err);
    });
  </script>
</body>
</html>
