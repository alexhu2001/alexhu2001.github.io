<!DOCTYPE html>
<html lang="en">
<head>
<style>
  .tab { overflow: hidden; border-bottom: 1px solid #ccc; }
  .tab button { background: none; border: none; padding: 10px 16px; cursor: pointer; }
  .tab button.active { background: #ccc; }
  .tabcontent { display: none; padding: 16px; }
</style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
<!-- Tab buttons -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Info')">Info</button>
  <button class="tablinks" onclick="openTab(event, 'Dashboard')" id="defaultOpen">Energy Usage</button>
  <button class="tablinks" onclick="openTab(event, 'Forecast')">Weather Forecast</button>
</div>
<!-- Dashboard tab -->
<div id="Dashboard" class="tabcontent">
  <h1 id="title">Energy Usage Analysis</h1>
  <label for="homeSelect">Select Home:</label>
  <select id="homeSelect"></select>
  <div id="chart"></div>
  <div id="msg" style="color:red;"></div>
  <!-- ===== Winter/Summer Comparison Section START ===== -->
  <hr>
  <h2 id="title2">Seasonal Energy Usage Breakdown by Category (%)</h2>
  <div id="summerChart"></div>
  <div id="winterChart"></div>
  <!-- ===== Winter/Summer Comparison Section END ===== -->
  <hr>
  <h2 id="titleHourly">Hourly Energy Use (24 Hours)</h2>
  <div id="hourlyChart"></div>
  <hr>
  <h2 id="titleDayOfWeek">Average Energy Use by Day of Week</h2>
  <div id="dayOfWeekChart"></div>
</div>
<!-- Info tab -->
<div id="Info" class="tabcontent">
  <h2>About this Dashboard</h2>
  <p>This tool shows monthly electricity consumption for selected homes, compared with the community average.</p>
</div>
<!-- Forecast tab -->
<div id="Forecast" class="tabcontent">
  <h2>7-Day Weather Forecast</h2>
  <div id="tempChart"></div>
  <div id="cloudChart"></div>
  <div id="solarChart"></div>
</div>
  <script>
    const params = new URLSearchParams(window.location.search);
    let bldg = params.get("bldg") || "7352";
    function parseHeaderDate(s) {
      const parts = s.split("/");
      if (parts.length === 3) {
        const [m, d, y] = parts.map(p => parseInt(p, 10));
        return new Date(y, m - 1, d);
      }
      return new Date(s);
    }
//通用绘图函数：无数据则隐藏，有数据则绘制
function safePlot(divId, data, layout) {
  const div = document.getElementById(divId);
  // Always reset visibility before checking
  div.style.display = "block";
  div.innerHTML = ""; // clear any old content
  if (!data || data.length === 0 || data.every(t => !t.y || t.y.length === 0)) {
    div.style.display = "none";   // hide if no data
  } else {
    Plotly.newPlot(divId, data, layout, {responsive:true});
  }
}
    d3.csv("DataSummary.csv").then(function(data) {
      const headers = data.columns;
      const dateCols = headers.slice(1);
      
      // Compute average for each month across all homes
      const avgByMonth = {};
      dateCols.forEach(col => {
        let vals = data
          .map(row => {
            const v = row[col];
            return (v && v.trim() !== "") ? +v : null;
          })
          .filter(v => v !== null && !isNaN(v));
        if (vals.length > 0) {
          avgByMonth[col] = d3.mean(vals);
        }
      });
      
      // Populate dropdown
      const selectEl = document.getElementById("homeSelect");
      data.forEach(row => {
        const id = row["dataid"];
        if (id) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = id;
          selectEl.appendChild(opt);
        }
      });
      selectEl.value = bldg;

      function drawChart(homeId) {
        const row = data.find(d => String(d["dataid"]).trim() === String(homeId));
        if (!row) {
          document.getElementById("msg").innerText = "No data for " + homeId;
          return;
        }

        const x = [], y = [];
        dateCols.forEach(col => {
          const val = row[col];
          if (val && val.trim() !== "") {
            x.push(parseHeaderDate(col));
            y.push(+val);
          }
        });
        if (x.length === 0) {
          document.getElementById("msg").innerText = "No values found for Home " + homeId;
          safePlot("chart", [], {});   // hide chart properly
          return;
        }
        
        const avgX = [], avgY = [];
        dateCols.forEach(col => {
          if (avgByMonth[col] !== undefined) {
            avgX.push(parseHeaderDate(col));
            avgY.push(avgByMonth[col]);
          }
        });
        
        const maxValHome = Math.max(...y);
        const maxValAvg = avgY.length > 0 ? Math.max(...avgY) : 0;
        const yMax = Math.max(maxValHome, maxValAvg) * 1.2;

        safePlot("chart", [
          {
            x: x,
            y: y,
            type: "scatter",
            mode: "lines+markers",
            name: "Home " + homeId
          },
          {
            x: avgX,
            y: avgY,
            type: "scatter",
            mode: "lines",
            name: "Community Average",
            line: { color: "red", dash: "dot" }
          }
        ], {
          title: "Total Energy Consumption by Month for Home " + homeId,
          xaxis: { title: "Month", type: "date" },
          yaxis: { title: "kWh", range: [0, yMax] },
        });
      }

      // Initial draw
      drawChart(bldg);
      document.getElementById("msg").innerText = "";
      // Dropdown change
      selectEl.addEventListener("change", () => {
        const newId = selectEl.value;
        const url = new URL(window.location);
        url.searchParams.set("bldg", newId);
        window.history.replaceState({}, "", url);
        drawChart(newId);
      });
<!-- ===== Winter/Summer Comparison Code START ===== -->
Promise.all([
  d3.csv("Category_SummerDailyAvg.csv"),
  d3.csv("Category_WinterDailyAvg.csv")
]).then(([summer, winter]) => {
  function avgRow(data) {
    const result = {};
    data.columns.slice(1).forEach(col => {
      const vals = data.map(r => +r[col]).filter(v => v > 0);
      if (vals.length > 0) result[col] = d3.mean(vals);
    });
    return result;
  }

  const sAvg = avgRow(summer);
  const wAvg = avgRow(winter);

  function prepPercent(row, avg, labelHome, labelAvg) {
    if (!row) return [];
    const entries = Object.keys(row)
      .filter(k => k !== "dataid" && +row[k] > 0)
      .map(k => ({ cat: k, val: +row[k] }));
    const total = d3.sum(entries, d => d.val);
    const homeData = entries.map(d => ({ cat: d.cat, val: d.val / total * 100, type: labelHome }));

    const avgEntries = Object.keys(avg)
      .filter(k => avg[k] > 0)
      .map(k => ({ cat: k, val: avg[k] }));
    const avgTotal = d3.sum(avgEntries, d => d.val);
    const avgData = avgEntries.map(d => ({ cat: d.cat, val: d.val / avgTotal * 100, type: labelAvg }));

    return [...homeData, ...avgData];
  }

  function makeTraces(data) {
    const types = [...new Set(data.map(d => d.type))];
    return types.map(t => {
      const filtered = data.filter(d => d.type === t);
      return {
        x: filtered.map(d => d.cat),
        y: filtered.map(d => d.val),
        name: t,
        type: "bar",
        text: filtered.map(d => d.val.toFixed(1) + "%"),
        textposition: "outside"
      };
    });
  }

  // Keep hourly at top-level inside this Promise block
function drawHourlyChart(homeId) {
  Plotly.d3.csv("HourlyEnergy.csv", function(err, rows) {
    if (err) {
      console.error("Error loading HourlyEnergy.csv:", err);
      return;
    }
    const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
    const hours = filtered.map(r => +r.hour);
    const values = filtered.map(r => +r.grid);
const trace = {
  x: hours,
  y: values,
  type: "scatter",
  mode: "lines+markers+text",   // add text labels
  text: values.map(v => v.toFixed(1) + " kWh"), // label each point
  textposition: "top center",
  line: { color: "#1f77b4", width: 2 },
  marker: { size: 6 },
  name: "Grid Energy Use"
};
    const layout = {
      title: "Hourly Energy Use for Home " + homeId,
      xaxis: {
        title: "Hour of Day",
        tickmode: "linear",
        dtick: 1,
        range: [0, 23]
      },
      yaxis: {
        title: "Energy Use (kWh)"
      }
    };
    safePlot("hourlyChart", [trace], layout);
  });
}
// ===== Day of Week chart =====
function drawDayOfWeekChart(homeId) {
  Plotly.d3.csv("DayOfWeek.csv", function(err, rows) {
    if (err) {
      console.error("Error loading DayOfWeek.csv:", err);
      return;
    }
    // Filter for the selected home
    const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
    // Map day numbers to names
    const dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
    const days = filtered.map(r => dayNames[+r.day_of_week]);
    const values = filtered.map(r => +r.grid);
    // --- Community average across all homes ---
    const grouped = d3.nest()
      .key(d => +d.day_of_week)
      .rollup(v => d3.mean(v, d => +d.grid))
      .entries(rows);
    const avgDays = grouped.map(d => dayNames[d.key]);
    const avgValues = grouped.map(d => d.value);
    // --- Traces ---
    const traceHome = {
      x: days,
      y: values,
      type: "bar",
      text: values.map(v => v.toFixed(1) + " kWh"), // labels above bars
      textposition: "outside",
      marker: { color: "#2ca02c" },
      name: "Home " + homeId
    };
    const traceAvg = {
      x: avgDays,
      y: avgValues,
      type: "bar",
      text: avgValues.map(v => v.toFixed(1) + " kWh"),
      textposition: "outside",
      marker: { color: "orange" },
      name: "Community Average"
    };

    const layout = {
      barmode: "group",
      title: "Average Daily Energy Use by Day of Week for Home " + homeId,
      xaxis: { title: "Day of Week" },
      yaxis: { title: "Energy Use (kWh)" }
    };
    safePlot("dayOfWeekChart", [traceHome, traceAvg], layout);
  });
}
  // The ONLY seasonal function — do not redefine it later
  function drawSeasonCharts(homeId) {
    document.getElementById("msg").innerText = "";
    const sRow = summer.find(d => String(d.dataid).trim() === String(homeId).trim());
    const wRow = winter.find(d => String(d.dataid).trim() === String(homeId).trim());
    const summerData = sRow ? prepPercent(sRow, sAvg, "Home " + homeId, "Community Average") : [];
    const winterData = wRow ? prepPercent(wRow, wAvg, "Home " + homeId, "Community Average") : [];
    const maxValS = d3.max(summerData, d => d.val) || 0;
    const maxValW = d3.max(winterData, d => d.val) || 0;
    safePlot("summerChart", makeTraces(summerData), {
      barmode: "group",
      title: "Summer (June-Aug) Energy Usage Distribution by Category for Home " + homeId,
      yaxis: { title: "% of total household energy use", range: [0, maxValS * 1.2] },
      xaxis: { title: "Category" }
    });
    safePlot("winterChart", makeTraces(winterData), {
      barmode: "group",
      title: "Winter (Dec-Feb) Energy Usage Distribution by Category for Home " + homeId,
      yaxis: { title: "% of total household energy use", range: [0, maxValW * 1.2] },
      xaxis: { title: "Category" }
    });
  }
  // Hookups
document.getElementById("homeSelect").addEventListener("change", e => {
  drawSeasonCharts(e.target.value);
  drawHourlyChart(e.target.value);
  drawDayOfWeekChart(e.target.value);
});

if (data.find(d => d.dataid === bldg)) {
  drawSeasonCharts(bldg);
  drawHourlyChart(bldg);
  drawDayOfWeekChart(bldg);
}

}).catch(err => {
  document.getElementById("msg").innerText = "Error loading CSV: " + err;
  console.error(err);
});
    }).catch(err => {
      document.getElementById("msg").innerText = "Error loading CSV: " + err;
      console.error(err);
    });
// Tab switching
function openTab(evt, tabName) {
  document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
  document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.classList.add("active");
}
// Open default tab
document.getElementById("defaultOpen").click();
    <script>
<script>
// ===== Forecast charts =====
function loadForecast() {
  fetch("https://api.open-meteo.com/v1/forecast?latitude=33.749&longitude=-84.388&hourly=temperature_2m,apparent_temperature,cloudcover,shortwave_radiation&timezone=America/New_York")
    .then(res => res.json())
    .then(data => {
      const times = data.hourly.time;
      const temp = data.hourly.temperature_2m;
      const appTemp = data.hourly.apparent_temperature;
      const precip = data.hourly.precipitation;
      const solar = data.hourly.shortwave_radiation;
// --- Temperature vs Apparent Temperature ---
Plotly.newPlot("tempChart", [traceTemp, traceApp], { ... });
// --- Cloud Cover ---
const traceCloud = {
  x: times, y: data.hourly.cloudcover, type: "scatter", mode: "lines",
  name: "Cloud Cover (%)", line: { color: "gray" }
};
Plotly.newPlot("cloudChart", [traceCloud], {
  title: "Hourly Cloud Cover",
  xaxis: { title: "Time" },
  yaxis: { title: "%" },
  hovermode: "x unified"
});
// --- Solar Radiation ---
const traceSolar = {
  x: times, y: data.hourly.shortwave_radiation, type: "scatter", mode: "lines",
  name: "Solar Radiation (W/m²)", line: { color: "gold" }
};
Plotly.newPlot("solarChart", [traceSolar], {
  title: "Hourly Solar Radiation",
  xaxis: { title: "Time" },
  yaxis: { title: "W/m²" },
  hovermode: "x unified"
});
}
// Hook forecast loader to Forecast tab button
document.querySelector("button[onclick*='Forecast']").addEventListener("click", loadForecast);
</script>
</body>
</html>
