<!DOCTYPE html>
<html lang="en">
<head>
<style>
  body { font-family: sans-serif; margin: 20px; }
  .tab { overflow: hidden; border-bottom: 1px solid #ccc; }
  .tab button { background: none; border: none; padding: 10px 16px; cursor: pointer; font-size: 16px; }
  .tab button.active { background: #e0e0e0; font-weight: bold; }
  .tabcontent { display: none; padding: 20px 0; animation: fadeEffect 0.5s; }
  @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
  
  .info-card {
    display: grid; grid-template-columns: 40px auto; gap: 10px 15px;
    padding: 15px; border: 1px solid #ddd; border-radius: 8px;
    max-width: 400px; background: #fafafa;
  }
  .info-card .icon { font-size: 1.2em; text-align: center; }
  .info-card .label { font-weight: bold; color: #555; }
  
  /* Savings Calculator Styles */
  .savings-dashboard { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px; }
  .controls-card { flex: 1; min-width: 300px; background: #f8f9fa; padding: 25px; border-radius: 8px; border: 1px solid #e9ecef; }
  .results-card { flex: 1.5; min-width: 400px; display: flex; flex-direction: column; }
  .savings-slider { width: 100%; cursor: pointer; }
</style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>

<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Info')">Info</button>
  <button class="tablinks" onclick="openTab(event, 'Dashboard')" id="defaultOpen">Energy Usage</button>
  <button class="tablinks" onclick="openTab(event, 'Cost')">Energy Cost Analysis</button>
  <button class="tablinks" onclick="openTab(event, 'Forecast')">Weather Forecast</button>
</div>

<div id="Info" class="tabcontent">
  <h2>About</h2>
  <p style="max-width: 800px; line-height: 1.6;">
    This dashboard was created as part of a collaborative effort between researchers and community partners to transform energy data into meaningful insights. It integrates household consumption records with seasonal, hourly, and weather data to provide a multi-layered understanding of energy behavior.
  </p>
  <div id="homeInfoCard" class="info-card">Loading...</div>
</div>

<div id="Dashboard" class="tabcontent">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2 id="title">Energy Usage Analysis</h2>
    <div>
      <label for="homeSelect" style="font-weight:bold;">Select Home:</label>
      <select id="homeSelect" style="padding:5px; font-size:16px;"></select>
    </div>
  </div>

  <div id="chart"></div>
  <div id="msg" style="color:red;"></div>

  <h2 id="titleCost">Monthly Energy Cost</h2>
  <div id="monthlyCostChart"></div>

  <hr>
  <h2 id="title2">Seasonal Energy Usage Breakdown (%)</h2>
  <div style="display: flex; flex-wrap: wrap;">
    <div id="summerChart" style="flex:1; min-width:400px;"></div>
    <div id="winterChart" style="flex:1; min-width:400px;"></div>
  </div>

  <hr>
  <h2 id="titleHourly">Hourly Energy Use (24 Hours)</h2>
  <div id="hourlyChart"></div>

  <hr>
  <h2 id="titleDayOfWeek">Average Energy Use by Day of Week</h2>
  <div id="dayOfWeekChart"></div>
</div>

<div id="Cost" class="tabcontent">
    <h2>Estimated Monthly Energy Cost</h2>
    <p style="max-width:800px;">
        These estimates include basic service fees, energy charges, and taxes based on standard residential rates.
        Select a home to view its specific cost breakdown.
    </p>
    
    <div style="margin-bottom: 20px;">
        <label for="homeSelectCost" style="font-weight:bold;">Select Home:</label>
        <select id="homeSelectCost" style="padding:5px; font-size:16px;"></select>
    </div>
    
    <div id="costChart"></div>

    <hr style="margin-top: 40px; border-top: 1px solid #ddd;">
    <h2 style="margin-top: 20px;">Targeted Savings Calculator</h2>
    <p style="max-width: 800px; color: #555;">
        Adjust the sliders to simulate reducing usage in specific categories.
        The chart below shows your <strong>projected monthly bill</strong>.
    </p>

    <div class="savings-dashboard">
        <div class="controls-card">
            <h3 style="margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                Reduce Usage By...
            </h3>
            <div id="sliderContainer"><p>Loading...</p></div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="resetSliders()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reset All
                </button>
            </div>
        </div>

        <div class="results-card">
            <div id="savingsResultChart" style="height: 400px;"></div>
            <div id="savingsBigNumber" style="text-align: center; margin-top: 10px; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724; font-size: 1.2em;">
                Estimated Total Savings: <strong>$0.00</strong>
            </div>
        </div>
    </div>
</div>

<div id="Forecast" class="tabcontent">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>7-Day Weather Forecast</h2>
    <button id="weatherToggleBtn" onclick="toggleWeatherUnit()" style="padding:8px 16px; cursor:pointer; font-weight:bold; border-radius:4px; border:1px solid #ccc;">
      Switch to Â°C
    </button>
  </div>
  <div id="tempChart"></div>
  <div id="cloudChart"></div>
  <div id="solarChart"></div>
</div>

<script>
    // --- 1. Global Setup & ID Mapping ---
    const ID_MAP = {
        "2005": "1", "2462": "2", "2542": "3", "2933": "4", "3485": "5",
        "3841": "6", "4399": "7", "5265": "8", "7246": "9", "7352": "10",
        "7624": "11", "9765": "12", "9783": "13", "10323": "14", "10532": "15",
        "10686": "16", "11744": "17", "6820": "18", "10458": "19"
    };

    const params = new URLSearchParams(window.location.search);
    let rawBldg = params.get("bldg") || "7352";
    let bldg = ID_MAP[rawBldg] || rawBldg;
    if (bldg === "7352") bldg = "10"; // Default fallback

    // --- 2. Monkey Patch d3.csv (Auto Map & Sort IDs) ---
    const originalD3Csv = d3.csv;
    d3.csv = function(url, ...args) {
        return originalD3Csv(url, ...args).then(data => {
            data.forEach(row => { if (row.dataid && ID_MAP[row.dataid]) row.dataid = ID_MAP[row.dataid]; });
            data.sort((a, b) => Number(a.dataid) - Number(b.dataid));
            return data;
        });
    };
    if (window.Plotly && Plotly.d3) {
        const originalPlotlyCsv = Plotly.d3.csv;
        Plotly.d3.csv = function(url, callback) {
            originalPlotlyCsv(url, function(err, rows) {
                if (rows) {
                    rows.forEach(row => { if (row.dataid && ID_MAP[row.dataid]) row.dataid = ID_MAP[row.dataid]; });
                    rows.sort((a, b) => Number(a.dataid) - Number(b.dataid));
                }
                callback(err, rows);
            });
        };
    }

    function parseHeaderDate(s) {
        const parts = s.split("/");
        if (parts.length === 3) return new Date(parts[2], parts[0]-1, parts[1]);
        return new Date(s);
    }

    function safePlot(divId, data, layout) {
        const div = document.getElementById(divId);
        if(!div) return;
        div.style.display = "block";
        div.innerHTML = "";
        if (!data || data.length === 0 || data.every(t => !t.y || t.y.length === 0)) {
            div.style.display = "none";
        } else {
            Plotly.newPlot(divId, data, layout, {responsive: true});
        }
    }

    // --- 3. Cost Calculator Logic ---
    function calculateCost(kwh, dateStr) {
        if (!kwh || kwh <= 0) return 0;
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return 0;
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth() + 1;
        const numDays = new Date(year, month, 0).getDate();
        const basicCharge = 0.4603 * numDays;
        const isSummer = [6, 7, 8, 9].includes(month);
        let energyCharge = 0;
        if (isSummer) {
            if (kwh <= 650) energyCharge = kwh * 0.086;
            else if (kwh <= 1000) energyCharge = (650 * 0.086) + ((kwh - 650) * 0.143);
            else energyCharge = (650 * 0.086) + (350 * 0.143) + ((kwh - 1000) * 0.148);
        } else {
            energyCharge = kwh * 0.081;
        }
        const subtotal = basicCharge + energyCharge;
        const eccr = kwh * 0.0145;
        const mff = (subtotal + eccr) * 0.030674;
        const salesTax = (subtotal + eccr + mff) * 0.089;
        return Math.round((subtotal + eccr + mff + salesTax) * 100) / 100;
    }

    // --- 4. Main Data Loading & Chart Drawing ---
    Promise.all([
        d3.csv("MonthlyEnergy_28days.csv"),
        d3.csv("Category_SummerDailyAvg.csv"),
        d3.csv("Category_WinterDailyAvg.csv"),
        d3.csv("Category_SpringDailyAvg.csv"),
        d3.csv("Category_FallDailyAvg.csv")
    ]).then(([monthlyData, summer, winter, spring, fall]) => {
        
        const dateCols = monthlyData.columns.slice(1);
        const avgByMonth = {};
        dateCols.forEach(col => {
            const vals = monthlyData.map(r => +r[col]).filter(v => v > 0);
            if (vals.length) avgByMonth[col] = d3.mean(vals);
        });

        // Populate Dropdowns
        const selectEl = document.getElementById("homeSelect");
        const selectCost = document.getElementById("homeSelectCost");
        monthlyData.forEach(d => {
            if(d.dataid) {
                selectEl.add(new Option(d.dataid, d.dataid));
                selectCost.add(new Option(d.dataid, d.dataid));
            }
        });

        // --- CHART FUNCTIONS ---
        
        // Tab 2: Main Usage
        function drawMainChart(homeId) {
            const row = monthlyData.find(d => d.dataid == homeId);
            if (!row) { document.getElementById("msg").innerText = "No data"; return; }
            const x = [], y = [], avgX = [], avgY = [];
            dateCols.forEach(col => {
                if(row[col]) { x.push(parseHeaderDate(col)); y.push(+row[col]); }
                if(avgByMonth[col]) { avgX.push(parseHeaderDate(col)); avgY.push(avgByMonth[col]); }
            });
            safePlot("chart", [
                { x:x, y:y, type:"scatter", mode:"lines+markers", name:"Home "+homeId },
                { x:avgX, y:avgY, type:"scatter", mode:"lines", name:"Avg", line:{color:"red", dash:"dot"} }
            ], { title: "Total Consumption (kWh)", xaxis:{type:"date"}, yaxis:{title:"kWh"} });
        }

        // Tab 2: Monthly Cost
        function drawMonthlyCostChart(homeId) {
            d3.csv("EnergyCost.csv").then(data => {
                const row = data.find(r => r.dataid == homeId);
                if(!row) return;
                const months = Object.keys(row).filter(k=>k!=="dataid");
                const vals = months.map(m=>+row[m]);
                const avgVals = months.map(m=> d3.mean(data.map(r=>+r[m]).filter(v=>!isNaN(v))));
                safePlot("monthlyCostChart", [
                    {x:months, y:vals, type:"scatter", mode:"lines+markers", name:"Home "+homeId},
                    {x:months, y:avgVals, type:"scatter", mode:"lines", name:"Avg", line:{color:"orange"}}
                ], {title:"Monthly Cost Trend ($)"});
            });
        }

        // Tab 2: Seasonal Bars
        function drawSeasonCharts(homeId) {
            function getPcts(row) {
                if(!row) return [];
                const cats = ["HVAC","Water_Heating_Pumps","Kitchen_Refrigeration","Laundry","Lighting_Plugs_Rooms"];
                const vals = cats.map(c => +row[c]||0);
                const total = d3.sum(vals);
                return total ? cats.map((c,i)=>({c:c, v:(vals[i]/total)*100})) : [];
            }
            const sData = getPcts(summer.find(d=>d.dataid==homeId));
            const wData = getPcts(winter.find(d=>d.dataid==homeId));
            safePlot("summerChart", [{x:sData.map(d=>d.c), y:sData.map(d=>d.v), type:"bar", text:sData.map(d=>d.v.toFixed(1)+"%")}], {title:"Summer Breakdown", yaxis:{title:"%"}});
            safePlot("winterChart", [{x:wData.map(d=>d.c), y:wData.map(d=>d.v), type:"bar", text:wData.map(d=>d.v.toFixed(1)+"%")}], {title:"Winter Breakdown", yaxis:{title:"%"}});
        }

        // Tab 3: Cost Bar Chart
        function drawCostChart(homeId) {
            const row = monthlyData.find(d => d.dataid == homeId);
            if(!row) return;
            const valid = dateCols.filter(m => +row[m] > 0);
            const costs = valid.map(m => calculateCost(+row[m], m));
            const avgs = valid.map(m => calculateCost(avgByMonth[m], m));
            safePlot("costChart", [
                {x:valid, y:costs, type:"scatter", mode:"lines+markers", name:"Home "+homeId, line:{color:"#1f77b4"}},
                {x:valid, y:avgs, type:"scatter", mode:"lines", name:"Avg", line:{color:"red", dash:"dot"}}
            ], {title:"Estimated Monthly Cost", template:"simple_white", yaxis:{title:"$"}});
        }

        // Tab 3: Savings Calculator (Line Chart)
        window.drawSavingsCalculator = function(homeId) {
            const container = document.getElementById("sliderContainer");
            if(!container) return;
            container.innerHTML = "";
            const homeRow = monthlyData.find(d => d.dataid == homeId);
            if(!homeRow) { container.innerHTML = "No Data"; return; }

            const cats = ["HVAC","Water_Heating_Pumps","Kitchen_Refrigeration","Laundry","Lighting_Plugs_Rooms"];
            const labels = {"HVAC":"HVAC", "Water_Heating_Pumps":"Water Heating", "Kitchen_Refrigeration":"Kitchen", "Laundry":"Laundry", "Lighting_Plugs_Rooms":"Lights"};
            const sliderState = {}; cats.forEach(c => sliderState[c] = 0);
            const seasonMap = { 'summer': summer, 'winter': winter, 'spring': spring, 'fall': fall };
            const getSeason = m => [6,7,8].includes(m)?'summer':[12,1,2].includes(m)?'winter':[3,4,5].includes(m)?'spring':'fall';

            // Draw Sliders
            cats.forEach(cat => {
                const div = document.createElement("div");
                div.style.marginBottom = "10px";
                div.innerHTML = `<div style="display:flex; justify-content:space-between"><b>${labels[cat]}</b><span id="lbl_${cat}" style="color:blue">0%</span></div>`;
                const input = document.createElement("input");
                input.type = "range"; input.min = 0; input.max = 50; input.step = 5; input.value = 0; input.className = "savings-slider"; input.style.width="100%";
                input.oninput = function() {
                    document.getElementById("lbl_"+cat).innerText = "-" + this.value + "%";
                    sliderState[cat] = this.value / 100;
                    updateProj();
                };
                div.appendChild(input); container.appendChild(div);
            });

            function updateProj() {
                const months = dateCols.filter(m => +homeRow[m] > 0);
                const curr = [], proj = [];
                let saved = 0;
                
                months.forEach(m => {
                    const kwh = +homeRow[m];
                    const dObj = new Date(m);
                    const sRow = seasonMap[getSeason(dObj.getMonth()+1)].find(d => d.dataid == homeId);
                    let kwhSaved = 0;
                    
                    if(sRow) {
                        const vals = cats.map(c => +sRow[c]||0);
                        const total = d3.sum(vals);
                        if(total) cats.forEach((c,i) => kwhSaved += kwh * (vals[i]/total) * sliderState[c]);
                    }
                    const cBill = calculateCost(kwh, m);
                    const pBill = calculateCost(kwh - kwhSaved, m);
                    curr.push(cBill); proj.push(pBill);
                    saved += (cBill - pBill);
                });

                document.getElementById("savingsBigNumber").innerHTML = `Estimated Total Savings: <strong>$${saved.toFixed(2)}</strong>`;
                Plotly.react("savingsResultChart", [
                    {x:months, y:curr, type:"scatter", mode:"lines+markers", name:"Current", line:{color:"#333"}},
                    {x:months, y:proj, type:"scatter", mode:"lines+markers", name:"Projected", line:{color:"green", dash:"dot"}, fill:"tonexty"}
                ], {title:"Projected Bill Savings", template:"simple_white", margin:{t:40,l:60,r:20,b:40}}, {displayModeBar:false});
            }
            updateProj();
        };
        window.resetSliders = function() { document.querySelectorAll(".savings-slider").forEach(s => { s.value=0; s.dispatchEvent(new Event('input')); }); };

        // === GLOBAL SYNC HANDLER ===
        window.updateDashboard = function(id) {
            selectEl.value = id; selectCost.value = id;
            
            // Draw All Charts
            drawMainChart(id);
            drawMonthlyCostChart(id);
            drawSeasonCharts(id);
            drawCostChart(id);
            drawSavingsCalculator(id);
            
            // These load their own data, so just call them
            drawHourlyChart(id);
            drawDayOfWeekChart(id);
            drawHomeInfo(id);
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set("bldg", id);
            window.history.replaceState({}, "", url);
        };

        // Listeners
        selectEl.addEventListener("change", e => updateDashboard(e.target.value));
        selectCost.addEventListener("change", e => updateDashboard(e.target.value));
        
        // Init
        updateDashboard(bldg);

    }).catch(err => console.error(err));

    // --- 5. Independent Charts (Hourly, Day, Info) ---
    function drawHourlyChart(homeId) {
        Plotly.d3.csv("HourlyEnergy.csv", (err, rows) => {
            if(err) return;
            const f = rows.filter(r => r.dataid == homeId);
            const hrs = f.map(r=>+r.hour), vals = f.map(r=>+r.grid);
            const grp = d3.nest().key(d=>+d.hour).rollup(v=>d3.mean(v,d=>+d.grid)).entries(rows);
            safePlot("hourlyChart", [
                {x:hrs, y:vals, type:"scatter", mode:"lines+markers", name:"Home "+homeId},
                {x:grp.map(d=>d.key), y:grp.map(d=>d.value), type:"scatter", mode:"lines", name:"Avg", line:{dash:"dot"}}
            ], {title:"Hourly Energy Use", xaxis:{title:"Hour"}});
        });
    }
    function drawDayOfWeekChart(homeId) {
        Plotly.d3.csv("DayOfWeek.csv", (err, rows) => {
            if(err) return;
            const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
            const f = rows.filter(r => r.dataid == homeId);
            const vals = f.map(r=>+r.grid);
            const grp = d3.nest().key(d=>+d.day_of_week).rollup(v=>d3.mean(v,d=>+d.grid)).entries(rows);
            safePlot("dayOfWeekChart", [
                {x:days, y:vals, type:"bar", name:"Home "+homeId},
                {x:days, y:grp.map(d=>d.value), type:"bar", name:"Avg"}
            ], {title:"Daily Use by Day of Week", barmode:"group"});
        });
    }
    function drawHomeInfo(homeId) {
        d3.csv("PropertyData.csv").then(rows => {
            const r = rows.find(d => d.dataid == homeId);
            const c = document.getElementById("homeInfoCard");
            if(!r) { c.innerHTML = "No Info"; return; }
            const items = [
                {i:"ðŸ ",l:"Exterior",v:r["Exterior Wall"]}, {i:"ðŸ“…",l:"Built",v:r["Year Built"]},
                {i:"ðŸ“",l:"Sq Ft",v:r["Res Sq Ft"]}, {i:"ðŸ›ï¸",l:"Beds",v:r["Bedrooms"]},
                {i:"ðŸ”¥",l:"Heating",v:r["Heating System"]}, {i:"ðŸ’²",l:"Value",v:r["Assessed Value"]}
            ];
            c.innerHTML = items.map(x=>`<div class="icon">${x.i}</div><div><span class="label">${x.l}:</span> ${x.v}</div>`).join("");
        });
    }

    // --- 6. Weather Forecast Logic (Corrected Units) ---
    let weatherUnit = 'fahrenheit'; 
    function toggleWeatherUnit() {
        weatherUnit = (weatherUnit === 'fahrenheit') ? 'celsius' : 'fahrenheit';
        loadForecast();
    }
    function loadForecast() {
        const isF = (weatherUnit === 'fahrenheit');
        const unitLabel = isF ? "Â°F" : "Â°C";
        const btn = document.getElementById("weatherToggleBtn");
        if(btn) btn.innerText = isF ? "Switch to Â°C" : "Switch to Â°F";
        
        // Correct Comfort Zone
        const yMin = isF ? 68 : 20;
        const yMax = isF ? 79 : 26;

        fetch(`https://api.open-meteo.com/v1/forecast?latitude=33.749&longitude=-84.388&hourly=temperature_2m,apparent_temperature,cloudcover,shortwave_radiation&timezone=America/New_York&temperature_unit=${weatherUnit}`)
        .then(r=>r.json()).then(d => {
            const t = d.hourly.time;
            const comfortZone = { type:"rect", xref:"x", yref:"y", x0:t[0], x1:t[t.length-1], y0:yMin, y1:yMax, fillcolor:"rgba(0,200,0,0.1)", line:{width:0}, layer:"below" };
            
            Plotly.newPlot("tempChart", [
                {x:t, y:d.hourly.temperature_2m, name:"Temp "+unitLabel, line:{color:"red"}},
                {x:t, y:d.hourly.apparent_temperature, name:"Feels Like", line:{color:"orange", dash:"dot"}}
            ], {title:"Temperature Forecast", yaxis:{title:unitLabel}, shapes:[comfortZone]}, {responsive:true});

            Plotly.newPlot("cloudChart", [{x:t, y:d.hourly.cloudcover, fill:"tozeroy", name:"Cloud %"}], {title:"Cloud Cover", yaxis:{title:"%"}}, {responsive:true});
            Plotly.newPlot("solarChart", [{x:t, y:d.hourly.shortwave_radiation, fill:"tozeroy", name:"Solar W/mÂ²", line:{color:"gold"}}], {title:"Solar Radiation", yaxis:{title:"W/mÂ²"}}, {responsive:true});
        });
    }
    document.querySelector("button[onclick*='Forecast']").addEventListener("click", loadForecast);

    // --- 7. Tab Switching & Resize ---
    function openTab(evt, tabName) {
        document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
        document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
        // Auto-Resize Charts
        const charts = document.getElementById(tabName).querySelectorAll('.js-plotly-plot');
        charts.forEach(c => Plotly.Plots.resize(c));
    }
    document.getElementById("defaultOpen").click();
    window.addEventListener('resize', () => document.querySelectorAll('.js-plotly-plot').forEach(c => Plotly.Plots.resize(c)));

</script>
</body>
</html>
