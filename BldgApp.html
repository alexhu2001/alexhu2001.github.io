<!DOCTYPE html>
<html lang="en">
<head>
<style>
  .tab { overflow: hidden; border-bottom: 1px solid #ccc; }
  .tab button { background: none; border: none; padding: 10px 16px; cursor: pointer; }
  .tab button.active { background: #ccc; }
  .tabcontent { display: none; padding: 16px; }
  .info-card {
  display: grid;
  grid-template-columns: 40px auto;
  gap: 10px 15px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  max-width: 400px;
  background: #fafafa;
  font-family: sans-serif;
}
.info-card .icon {
  font-size: 1.2em;
  text-align: center;
}
.info-card .label {
  font-weight: bold;
}
</style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
<!-- Tab buttons -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Info')">Info</button>
  <button class="tablinks" onclick="openTab(event, 'Dashboard')" id="defaultOpen">Energy Usage</button>
  <button class="tablinks" onclick="openTab(event, 'Cost')">Energy Cost Analysis</button>
  <button class="tablinks" onclick="openTab(event, 'Forecast')">Weather Forecast</button>
</div>
<!-- Dashboard tab -->
<div id="Dashboard" class="tabcontent">
  <h2 id="title">Energy Usage Analysis</h2>
  <label for="homeSelect">Select Home:</label>
  <select id="homeSelect"></select>
  <div id="chart"></div>
  <div id="msg" style="color:red;"></div>
  <h2 id="titleCost">Monthly Energy Cost</h2>
  <div id="monthlyCostChart"></div>
  <!-- ===== Winter/Summer Comparison Section START ===== -->
  <hr>
  <h2 id="title2">Seasonal Energy Usage Breakdown by Category (%)</h2>
  <div id="summerChart"></div>
  <div id="winterChart"></div>
  <!-- ===== Winter/Summer Comparison Section END ===== -->
  <hr>
  <h2 id="titleHourly">Hourly Energy Use (24 Hours)</h2>
  <div id="hourlyChart"></div>
  <hr>
  <h2 id="titleDayOfWeek">Average Energy Use by Day of Week</h2>
  <div id="dayOfWeekChart"></div>
</div>
<!-- ===== Energy Cost Tab ===== -->
<div id="Cost" class="tabcontent">
    <h2>Estimated Monthly Energy Cost</h2>
    <p style="max-width:800px;">
        These cost estimates are based on Georgia Powerâ€™s standard residential rates. 
        The calculation includes the basic service fee, energy charges, and required 
        city and state fees.
    </p>
    
    <label for="homeSelectCost">Select Home:</label>
    <select id="homeSelectCost"></select>
    
    <div id="costChart"></div>

    <hr style="margin-top: 40px; border-top: 1px solid #ddd;">
    <h2 style="margin-top: 20px;">Targeted Savings Calculator</h2>
    <p style="max-width: 800px; color: #555;">
        Adjust the sliders below to simulate reducing your usage in specific categories (e.g., reduce HVAC by 10%).
        The chart below shows your <strong>projected monthly bill</strong> across all months.
    </p>

    <div class="savings-dashboard" style="display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px;">
        <div class="controls-card" style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 25px; border-radius: 8px; border: 1px solid #e9ecef;">
            <h3 style="margin-top: 0; font-size: 1.1em; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                Reduce Usage By...
            </h3>
            <div id="sliderContainer">
                <p>Loading home data...</p>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="resetSliders()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reset All
                </button>
            </div>
        </div>

        <div class="results-card" style="flex: 1.5; min-width: 400px; display: flex; flex-direction: column;">
            <div id="savingsResultChart" style="height: 400px;"></div>
            <div id="savingsBigNumber" style="text-align: center; margin-top: 10px; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                Estimated Total Savings: <strong>$0.00</strong>
            </div>
        </div>
    </div>
</div>
<!-- Info tab -->
<div id="Info" class="tabcontent">
  <h2>About</h2>
  <p>This dashboard was created as part of a collaborative effort between researchers and community partners to transform energy data into meaningful insights that directly benefit local residents. By integrating household consumption records with seasonal, hourly, and dayâ€‘ofâ€‘week analyses, as well as weather forecasts and property characteristics, the tool provides a multiâ€‘layered understanding of how and when energy is used. Beyond simply tracking numbers, it highlights patterns, trends, and key drivers of demand, helping to establish a baseline for understanding household energy behavior. These findings are intended to support equitable and sustainable energy solutions by reducing costs, alleviating energy burdens, and empowering disadvantaged communities with knowledge that can inform both individual decisions and broader policy initiatives.</p>
  <div id="homeInfoCard" class="info-card"></div>
</div>
<!-- Forecast tab -->
<div id="Forecast" class="tabcontent">
  <h2>7-Day Weather Forecast</h2>
  <div id="tempChart"></div>
  <div id="cloudChart"></div>
  <div id="solarChart"></div>
</div>
<script>
    const params = new URLSearchParams(window.location.search);
    let bldg = params.get("bldg") || "7352";

    function parseHeaderDate(s) {
        const parts = s.split("/");
        if (parts.length === 3) {
            const [m, d, y] = parts.map(p => parseInt(p, 10));
            return new Date(y, m - 1, d);
        }
        return new Date(s);
    }

    // === Energy Cost Calculator ===
    function calculateCost(kwh, dateStr) {
        if (!kwh || kwh <= 0) return 0;
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return 0;

        const year = dateObj.getFullYear();
        const month = dateObj.getMonth() + 1;
        const numDays = new Date(year, month, 0).getDate();
        const basicCharge = 0.4603 * numDays;
        const isSummer = [6, 7, 8, 9].includes(month);

        let energyCharge = 0;
        if (isSummer) {
            if (kwh <= 650) energyCharge = kwh * 0.086;
            else if (kwh <= 1000) energyCharge = (650 * 0.086) + ((kwh - 650) * 0.143);
            else energyCharge = (650 * 0.086) + (350 * 0.143) + ((kwh - 1000) * 0.148);
        } else {
            energyCharge = kwh * 0.081;
        }

        const subtotal = basicCharge + energyCharge;
        const eccr = kwh * 0.0145;
        const mff = (subtotal + eccr) * 0.030674;
        const salesTax = (subtotal + eccr + mff) * 0.089;
        return Math.round((subtotal + eccr + mff + salesTax) * 100) / 100;
    }

    function safePlot(divId, data, layout) {
        const div = document.getElementById(divId);
        if(!div) return;
        div.style.display = "block";
        div.innerHTML = "";
        if (!data || data.length === 0 || data.every(t => !t.y || t.y.length === 0)) {
            div.style.display = "none";
        } else {
            Plotly.newPlot(divId, data, layout, {responsive: true});
        }
    }

    // --- Independent Chart Loaders ---
    function drawHourlyChart(homeId) {
        d3.csv("HourlyEnergy.csv").then(rows => {
            const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
            const hours = filtered.map(r => +r.hour);
            const values = filtered.map(r => +r.grid);
            const grouped = d3.nest().key(d => +d.hour).rollup(v => d3.mean(v, d => +d.grid)).entries(rows);
            const avgHours = grouped.map(d => d.key);
            const avgValues = grouped.map(d => d.value);
            safePlot("hourlyChart", [
                { x: hours, y: values, type: "scatter", mode: "lines+markers", name: "Home " + homeId, line: { color: "#1f77b4" } },
                { x: avgHours, y: avgValues, type: "scatter", mode: "lines", name: "Comm. Avg", line: { color: "orange", dash: "dot" } }
            ], { title: "Hourly Energy Use (24h)", xaxis: { title: "Hour", range: [0, 23] }, yaxis: { title: "kWh" } });
        });
    }

    function drawDayOfWeekChart(homeId) {
        d3.csv("DayOfWeek.csv").then(rows => {
            const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
            const dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
            const days = filtered.map(r => dayNames[+r.day_of_week]);
            const values = filtered.map(r => +r.grid);
            const grouped = d3.nest().key(d => +d.day_of_week).rollup(v => d3.mean(v, d => +d.grid)).entries(rows);
            const avgValues = grouped.map(d => d.value);
            safePlot("dayOfWeekChart", [
                { x: dayNames, y: values, type: "bar", name: "Home " + homeId, marker: { color: "#2ca02c" } },
                { x: dayNames, y: avgValues, type: "bar", name: "Comm. Avg", marker: { color: "orange" } }
            ], { title: "Avg Daily Use by Day", barmode: "group", yaxis: { title: "kWh" } });
        });
    }

    function drawHomeInfo(homeId) {
        d3.csv("PropertyData.csv").then(rows => {
            const row = rows.find(r => Number(r["dataid"]) === Number(homeId));
            const card = document.getElementById("homeInfoCard");
            if (!row) { card.innerHTML = "No info."; return; }
            const items = [
                {i:"ðŸ ", l:"Exterior", v:row["Exterior Wall"]}, {i:"ðŸ“…", l:"Built", v:row["Year Built"]},
                {i:"ðŸ“", l:"Sq Ft", v:row["Res Sq Ft"]}, {i:"ðŸ›ï¸", l:"Beds", v:row["Bedrooms"]},
                {i:"ðŸ”¥", l:"Heating", v:row["Heating System"]}, {i:"ðŸ’²", l:"Value", v:row["Assessed Value"]}
            ];
            card.innerHTML = items.map(x => `<div class="icon">${x.i}</div><div><span class="label">${x.l}:</span> ${x.v}</div>`).join("");
        });
    }

    function drawMonthlyCostChart(homeId) {
        d3.csv("EnergyCost.csv").then(data => {
            const row = data.find(r => r.dataid === homeId);
            if(!row) return;
            const months = Object.keys(row).filter(k => k !== "dataid");
            const values = months.map(m => +row[m]);
            const avgValues = months.map(m => d3.mean(data.map(r => +r[m]).filter(v => !isNaN(v))));
            safePlot("monthlyCostChart", [
                { x: months, y: values, type: "scatter", mode: "lines+markers", name: "Home " + homeId, marker: { color: "#1f77b4" } },
                { x: months, y: avgValues, type: "scatter", mode: "lines", name: "Comm. Avg", line: { color: "orange" } }
            ], { title: "Monthly Energy Cost", yaxis: { title: "$" } });
        });
    }

    // --- MAIN DATA LOADING BLOCK ---
    Promise.all([
        d3.csv("MonthlyEnergy_28days.csv"),
        d3.csv("Category_SummerDailyAvg.csv"),
        d3.csv("Category_WinterDailyAvg.csv"),
        d3.csv("Category_SpringDailyAvg.csv"),
        d3.csv("Category_FallDailyAvg.csv")
    ]).then(([monthlyData, summer, winter, spring, fall]) => {
        
        const headers = monthlyData.columns;
        const dateCols = headers.slice(1);
        
        // 1. Calculate Community Average
        const avgByMonth = {};
        dateCols.forEach(col => {
            const vals = monthlyData.map(r => +r[col]).filter(v => v > 0);
            if (vals.length) avgByMonth[col] = d3.mean(vals);
        });

        // 2. Populate Dropdowns
        const selectEl = document.getElementById("homeSelect");
        const selectCost = document.getElementById("homeSelectCost");
        selectEl.innerHTML = ""; selectCost.innerHTML = "";
        
        monthlyData.forEach(d => {
            if(d.dataid) {
                const opt1 = document.createElement("option"); opt1.value = d.dataid; opt1.textContent = d.dataid;
                selectEl.appendChild(opt1);
                const opt2 = document.createElement("option"); opt2.value = d.dataid; opt2.textContent = d.dataid;
                selectCost.appendChild(opt2);
            }
        });

        // 3. Tab 2 Main Chart
        function drawMainChart(homeId) {
            const row = monthlyData.find(d => d.dataid == homeId);
            if (!row) { document.getElementById("msg").innerText = "No data"; return; }
            const x = [], y = [], avgX = [], avgY = [];
            dateCols.forEach(col => {
                if(row[col]) { x.push(parseHeaderDate(col)); y.push(+row[col]); }
                if(avgByMonth[col]) { avgX.push(parseHeaderDate(col)); avgY.push(avgByMonth[col]); }
            });
            safePlot("chart", [
                { x: x, y: y, type: "scatter", mode: "lines+markers", name: "Home " + homeId },
                { x: avgX, y: avgY, type: "scatter", mode: "lines", name: "Comm. Avg", line: { color: "red", dash: "dot" } }
            ], { title: "Total Energy Consumption", xaxis: {type: "date"}, yaxis: {title: "kWh"} });
        }

        // 4. Tab 2 Seasonal Charts
        function drawSeasonCharts(homeId) {
            function getPcts(row) {
                if(!row) return [];
                const cats = ["HVAC","Water_Heating_Pumps","Kitchen_Refrigeration","Laundry","Lighting_Plugs_Rooms"];
                const vals = cats.map(c => +row[c] || 0);
                const total = d3.sum(vals);
                return total ? cats.map((c, i) => ({c:c, v:(vals[i]/total)*100})) : [];
            }
            const sRow = summer.find(d => d.dataid == homeId);
            const wRow = winter.find(d => d.dataid == homeId);
            const sData = getPcts(sRow);
            const wData = getPcts(wRow);
            safePlot("summerChart", [{x: sData.map(d=>d.c), y: sData.map(d=>d.v), type: "bar", text: sData.map(d=>d.v.toFixed(1)+"%")}], {title:"Summer Breakdown", yaxis:{title:"%"}});
            safePlot("winterChart", [{x: wData.map(d=>d.c), y: wData.map(d=>d.v), type: "bar", text: wData.map(d=>d.v.toFixed(1)+"%")}], {title:"Winter Breakdown", yaxis:{title:"%"}});
        }

        // 5. Tab 3 Cost Chart (Bar)
        function drawCostChart(homeId) {
            const row = monthlyData.find(d => d.dataid == homeId);
            if(!row) return;
            const validMonths = dateCols.filter(m => +row[m] > 0);
            const costs = validMonths.map(m => calculateCost(+row[m], m));
            const commCosts = validMonths.map(m => calculateCost(avgByMonth[m], m));
            
            safePlot("costChart", [
                { x: validMonths, y: costs, type: "scatter", mode: "lines+markers+text", text: costs.map(v=>"$"+Math.round(v)), textposition:"top center", name: "Home "+homeId, line:{color:"#1f77b4"} },
                { x: validMonths, y: commCosts, type: "scatter", mode: "lines", name: "Comm. Avg", line:{color:"red", dash:"dot"} }
            ], { title: "Estimated Monthly Energy Cost", template: "simple_white", yaxis:{title:"$"} });
        }

        // 6. Tab 3 Savings Calculator (The New Line Chart)
        window.drawSavingsCalculator = function(homeId) {
            const container = document.getElementById("sliderContainer");
            container.innerHTML = "";
            const homeRow = monthlyData.find(d => d.dataid == homeId);
            if(!homeRow) return;

            const cats = ["HVAC","Water_Heating_Pumps","Kitchen_Refrigeration","Laundry","Lighting_Plugs_Rooms"];
            const displayNames = {"HVAC":"HVAC","Water_Heating_Pumps":"Water Heating","Kitchen_Refrigeration":"Kitchen","Laundry":"Laundry","Lighting_Plugs_Rooms":"Lights"};
            const sliderState = {}; cats.forEach(c => sliderState[c] = 0);
            const seasonsMap = { 'summer': summer, 'winter': winter, 'spring': spring, 'fall': fall };
            const getSeason = m => [6,7,8].includes(m)?'summer':[12,1,2].includes(m)?'winter':[3,4,5].includes(m)?'spring':'fall';

            // Draw Sliders
            cats.forEach(cat => {
                const div = document.createElement("div");
                div.style.marginBottom = "10px";
                div.innerHTML = `<div style="display:flex; justify-content:space-between"><b>${displayNames[cat]}</b><span id="lbl_${cat}" style="color:blue">0%</span></div>`;
                const input = document.createElement("input");
                input.type = "range"; input.min = 0; input.max = 50; input.step = 5; input.value = 0; input.className = "savings-slider"; input.style.width="100%";
                input.oninput = function() {
                    document.getElementById("lbl_"+cat).innerText = "-" + this.value + "%";
                    sliderState[cat] = this.value / 100;
                    updateProjectedChart();
                };
                div.appendChild(input); container.appendChild(div);
            });

            function updateProjectedChart() {
                const months = dateCols.filter(m => +homeRow[m] > 0);
                const currCosts = [], projCosts = [];
                let totalSavings = 0;

                months.forEach(m => {
                    const kwh = +homeRow[m];
                    const currBill = calculateCost(kwh, m);
                    const dObj = new Date(m);
                    const season = getSeason(dObj.getMonth() + 1);
                    const sRow = seasonsMap[season].find(d => d.dataid == homeId);
                    
                    let savedKwh = 0;
                    if(sRow) {
                        const vals = cats.map(c => +sRow[c] || 0);
                        const total = d3.sum(vals);
                        if(total > 0) {
                            cats.forEach((c, i) => {
                                const share = vals[i] / total;
                                savedKwh += (kwh * share * sliderState[c]);
                            });
                        }
                    }
                    const newBill = calculateCost(kwh - savedKwh, m);
                    currCosts.push(currBill);
                    projCosts.push(newBill);
                    totalSavings += (currBill - newBill);
                });

                document.getElementById("savingsBigNumber").innerHTML = `Estimated Total Savings: <strong>$${totalSavings.toFixed(2)}</strong>`;
                
                const layout = { title: "Projected Bill Savings", yaxis: {title:"Cost ($)"}, template: "simple_white", margin: {t:40, b:40, l:60, r:20} };
                Plotly.react("savingsResultChart", [
                    { x: months, y: currCosts, type: "scatter", mode: "lines+markers", name: "Current", line:{color:"#343a40"} },
                    { x: months, y: projCosts, type: "scatter", mode: "lines+markers", name: "Projected", line:{color:"#28a745", dash:"dot"}, fill:"tonexty" }
                ], layout, {displayModeBar: false});
            }
            updateProjectedChart();
        };
        window.resetSliders = function() { document.querySelectorAll(".savings-slider").forEach(s => { s.value=0; s.dispatchEvent(new Event('input')); }); };

        // --- Master Update ---
        window.updateAll = function(id) {
            selectEl.value = id; selectCost.value = id;
            drawMainChart(id);
            drawSeasonCharts(id);
            drawHourlyChart(id);
            drawDayOfWeekChart(id);
            drawHomeInfo(id);
            drawMonthlyCostChart(id); // Tab 2
            drawCostChart(id);        // Tab 3 Top
            drawSavingsCalculator(id);// Tab 3 Bottom
        };

        selectEl.addEventListener("change", e => updateAll(e.target.value));
        selectCost.addEventListener("change", e => updateAll(e.target.value));
        updateAll(bldg);

    }).catch(err => {
        console.error(err);
        document.getElementById("msg").innerText = "Error loading data.";
    });

    // --- Forecast & Tabs ---
    function loadForecast() {
        fetch("https://api.open-meteo.com/v1/forecast?latitude=33.749&longitude=-84.388&hourly=temperature_2m,apparent_temperature,cloudcover,shortwave_radiation&timezone=America/New_York")
        .then(r=>r.json()).then(d => {
            const t = d.hourly.time;
            Plotly.newPlot("tempChart", [{x:t, y:d.hourly.temperature_2m, name:"Temp"}, {x:t, y:d.hourly.apparent_temperature, name:"Feels Like"}], {title:"Temperature"});
            Plotly.newPlot("cloudChart", [{x:t, y:d.hourly.cloudcover, fill:"tozeroy"}], {title:"Cloud Cover"});
            Plotly.newPlot("solarChart", [{x:t, y:d.hourly.shortwave_radiation, fill:"tozeroy"}], {title:"Solar Rad"});
        });
    }
    document.querySelector("button[onclick*='Forecast']").addEventListener("click", loadForecast);

    function openTab(evt, tabName) {
        document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
        document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }
    document.getElementById("defaultOpen").click();
</script>
</body>
</html>
