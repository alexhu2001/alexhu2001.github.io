<!DOCTYPE html>
<html lang="en">
<head>

<style>
  .tab { overflow: hidden; border-bottom: 1px solid #ccc; }
  .tab button { background: none; border: none; padding: 10px 16px; cursor: pointer; }
  .tab button.active { background: #ccc; }
  .tabcontent { display: none; padding: 12px; }
</style>

  <meta charset="UTF-8" />
  <title>Energy Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>

<!-- Tab buttons -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Dashboard')" id="defaultOpen">Dashboard</button>
  <button class="tablinks" onclick="openTab(event, 'Info')">Info</button>
</div>

<!-- Dashboard tab -->
<div id="Dashboard" class="tabcontent">
  <h1 id="title">Monthly Usage</h1>
  <label for="homeSelect">Select Home:</label>
  <select id="homeSelect"></select>
  <div id="chart"></div>
  <div id="msg" style="color:red;"></div>
  <!-- ===== Winter/Summer Comparison Section START ===== -->
  <hr>
  <h2>Winter vs Summer Usage by Category</h2>
  <label for="homeSelectSeason">Select Home:</label>
  <select id="homeSelectSeason"></select>
  <div id="seasonChart"></div>
  <!-- ===== Winter/Summer Comparison Section END ===== -->
</div>

<!-- Info tab -->
<div id="Info" class="tabcontent">
  <h2>About this Dashboard</h2>
  <p>This tool shows monthly electricity consumption for selected homes, compared with the community average.</p>
</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    let bldg = params.get("bldg") || "7352";

    function parseHeaderDate(s) {
      const parts = s.split("/");
      if (parts.length === 3) {
        const [m, d, y] = parts.map(p => parseInt(p, 10));
        return new Date(y, m - 1, d);
      }
      return new Date(s);
    }

    d3.csv("DataSummary.csv").then(function(data) {
      const headers = data.columns;
      const dateCols = headers.slice(1);
      
      // Compute average for each month across all homes
      const avgByMonth = {};
      dateCols.forEach(col => {
        let vals = data
          .map(row => {
            const v = row[col];
            return (v && v.trim() !== "") ? +v : null;
          })
          .filter(v => v !== null && !isNaN(v));
        if (vals.length > 0) {
          avgByMonth[col] = d3.mean(vals);
        }
      });
      
      // Populate dropdown
      const selectEl = document.getElementById("homeSelect");
      data.forEach(row => {
        const id = row["dataid"];
        if (id) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = id;
          selectEl.appendChild(opt);
        }
      });
      selectEl.value = bldg;

      function drawChart(homeId) {
        const row = data.find(d => String(d["dataid"]).trim() === String(homeId));
        if (!row) {
          document.getElementById("msg").innerText = "No data for " + homeId;
          return;
        }

        const x = [], y = [];
        dateCols.forEach(col => {
          const val = row[col];
          if (val && val.trim() !== "") {
            x.push(parseHeaderDate(col));
            y.push(+val);
          }
        });

        if (x.length === 0) {
          document.getElementById("msg").innerText = "No values found for " + homeId;
          return;
        }
        
        const avgX = [], avgY = [];
        dateCols.forEach(col => {
          if (avgByMonth[col] !== undefined) {
            avgX.push(parseHeaderDate(col));
            avgY.push(avgByMonth[col]);
          }
        });
        
        const maxValHome = Math.max(...y);
        const maxValAvg = avgY.length > 0 ? Math.max(...avgY) : 0;
        const yMax = Math.max(maxValHome, maxValAvg) * 1.2;

        Plotly.newPlot("chart", [
          {
            x: x,
            y: y,
            type: "scatter",
            mode: "lines+markers",
            name: "Home " + homeId
          },
          {
            x: avgX,
            y: avgY,
            type: "scatter",
            mode: "lines",
            name: "Community Average",
            line: { color: "red", dash: "dot" }
          }
        ], {
          title: "Monthly Consumption for Home " + homeId,
          xaxis: { title: "Month", type: "date" },
          yaxis: { title: "kWh", range: [0, yMax] },
        });
        
        document.getElementById("title").innerText = "Monthly Usage for Home " + homeId;
        document.getElementById("msg").innerText = "";
      }

      // Initial draw
      drawChart(bldg);

      // Dropdown change
      selectEl.addEventListener("change", () => {
        const newId = selectEl.value;
        const url = new URL(window.location);
        url.searchParams.set("bldg", newId);
        window.history.replaceState({}, "", url);
        drawChart(newId);
      });
      <!-- ===== Winter/Summer Comparison Code START ===== -->
<script>
Promise.all([
  d3.csv("Category_SummerDailyAvg.csv"),
  d3.csv("Category_WinterDailyAvg.csv")
]).then(([summer, winter]) => {
  const selectEl = document.getElementById("homeSelectSeason");
  const ids = summer.map(d => d.dataid);
  ids.forEach(id => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.text = id;
    selectEl.appendChild(opt);
  });

  function drawSeasonChart(homeId) {
    const sRow = summer.find(d => d.dataid === homeId);
    const wRow = winter.find(d => d.dataid === homeId);

    // 计算社区平均（忽略0）
    function avgRow(data) {
      const result = {};
      data.columns.slice(1).forEach(col => {
        const vals = data.map(r => +r[col]).filter(v => v > 0);
        if (vals.length > 0) result[col] = d3.mean(vals);
      });
      return result;
    }
    const sAvg = avgRow(summer);
    const wAvg = avgRow(winter);

    // 准备绘图数据（只保留非零项）
    function prep(row, label) {
      return Object.keys(row)
        .filter(k => k !== "dataid" && +row[k] > 0)
        .map(k => ({cat: k, val: +row[k], type: label}));
    }
    function prepAvg(avg, label) {
      return Object.keys(avg)
        .filter(k => avg[k] > 0)
        .map(k => ({cat: k, val: avg[k], type: label}));
    }

    const data = [
      ...prep(sRow, "Summer (Home)"),
      ...prep(wRow, "Winter (Home)"),
      ...prepAvg(sAvg, "Summer (Avg)"),
      ...prepAvg(wAvg, "Winter (Avg)")
    ];

    const types = [...new Set(data.map(d => d.type))];
    const traces = types.map(t => ({
      x: data.filter(d => d.type === t).map(d => d.cat),
      y: data.filter(d => d.type === t).map(d => d.val),
      name: t,
      type: "bar"
    }));

    Plotly.newPlot("seasonChart", traces, {
      barmode: "group",
      title: `Home ${homeId} vs Community Avg (Winter/Summer)`,
      yaxis: {title: "kWh/day"}
    });
  }

  selectEl.addEventListener("change", e => drawSeasonChart(e.target.value));
  drawSeasonChart(ids[0]); // 默认第一个
});
</script>
<!-- ===== Winter/Summer Comparison Code END ===== -->

    }).catch(err => {
      document.getElementById("msg").innerText = "Error loading CSV: " + err;
      console.error(err);
    });
    
    // Tab switching
function openTab(evt, tabName) {
  document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
  document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.classList.add("active");
}
// Open default tab
document.getElementById("defaultOpen").click();
  </script>
</body>
</html>
