<!DOCTYPE html>
<html lang="en">
<head>
<style>
  .tab { overflow: hidden; border-bottom: 1px solid #ccc; }
  .tab button { background: none; border: none; padding: 10px 16px; cursor: pointer; }
  .tab button.active { background: #ccc; }
  .tabcontent { display: none; padding: 16px; }
  .info-card {
  display: grid;
  grid-template-columns: 40px auto;
  gap: 10px 15px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  max-width: 400px;
  background: #fafafa;
  font-family: sans-serif;
}
.info-card .icon {
  font-size: 1.2em;
  text-align: center;
}
.info-card .label {
  font-weight: bold;
}
</style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
<!-- Tab buttons -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Info')">Info</button>
  <button class="tablinks" onclick="openTab(event, 'Dashboard')" id="defaultOpen">Energy Usage</button>
  <button class="tablinks" onclick="openTab(event, 'Cost')">Energy Cost Analysis</button>
  <button class="tablinks" onclick="openTab(event, 'Forecast')">Weather Forecast</button>
</div>
<!-- Dashboard tab -->
<div id="Dashboard" class="tabcontent">
  <h2 id="title">Energy Usage Analysis</h2>
  <label for="homeSelect">Select Home:</label>
  <select id="homeSelect"></select>
  <div id="chart"></div>
  <div id="msg" style="color:red;"></div>
  <h2 id="titleCost">Monthly Energy Cost</h2>
  <div id="monthlyCostChart"></div>
  <!-- ===== Winter/Summer Comparison Section START ===== -->
  <hr>
  <h2 id="title2">Seasonal Energy Usage Breakdown by Category (%)</h2>
  <div id="summerChart"></div>
  <div id="winterChart"></div>
  <!-- ===== Winter/Summer Comparison Section END ===== -->
  <hr>
  <h2 id="titleHourly">Hourly Energy Use (24 Hours)</h2>
  <div id="hourlyChart"></div>
  <hr>
  <h2 id="titleDayOfWeek">Average Energy Use by Day of Week</h2>
  <div id="dayOfWeekChart"></div>
</div>
<!-- ===== Energy Cost Tab ===== -->
<div id="Cost" class="tabcontent">
    <h2>Estimated Monthly Energy Cost</h2>
    <p>These cost estimates are based on Georgia Powerâ€™s standard residential rates. The calculation includes the basic service fee, energy charges, and required city and state fees. This gives families a simple way to understand what their electricity use might cost each month.
    <label for="homeSelectCost">Select Home:</label>
    <select id="homeSelectCost"></select>
<div id="costChart"></div> 
    <hr style="margin-top: 40px; border-top: 1px solid #ddd;">
    <h2 style="margin-top: 20px;">Targeted Savings Calculator</h2>
    <p style="max-width: 800px; color: #555;">
        Adjust the sliders to simulate reducing your usage in specific categories. 
        This tool uses your home's <strong>seasonal patterns</strong> (Summer, Winter, Spring, Fall) 
        to calculate a highly accurate estimated savings on your average monthly bill.
    </p>
    <div class="savings-dashboard" style="display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px;">
        <div class="controls-card" style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 25px; border-radius: 8px; border: 1px solid #e9ecef;">
            <h3 style="margin-top: 0; font-size: 1.1em; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                Reduce Usage By...
            </h3>
            <div id="sliderContainer">
                <p>Loading home data...</p>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="resetSliders()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reset All
                </button>
            </div>
        </div>
        <div class="results-card" style="flex: 1.5; min-width: 400px; display: flex; flex-direction: column;">
            <div id="savingsResultChart" style="height: 350px;"></div>
            <div id="savingsBigNumber" style="text-align: center; margin-top: 10px; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                Estimated Monthly Savings: <strong>$0.00</strong>
            </div>
        </div>
    </div>
</div>
<!-- Info tab -->
<div id="Info" class="tabcontent">
  <h2>About</h2>
  <p>This dashboard was created as part of a collaborative effort between researchers and community partners to transform energy data into meaningful insights that directly benefit local residents. By integrating household consumption records with seasonal, hourly, and dayâ€‘ofâ€‘week analyses, as well as weather forecasts and property characteristics, the tool provides a multiâ€‘layered understanding of how and when energy is used. Beyond simply tracking numbers, it highlights patterns, trends, and key drivers of demand, helping to establish a baseline for understanding household energy behavior. These findings are intended to support equitable and sustainable energy solutions by reducing costs, alleviating energy burdens, and empowering disadvantaged communities with knowledge that can inform both individual decisions and broader policy initiatives.</p>
  <div id="homeInfoCard" class="info-card"></div>
</div>
<!-- Forecast tab -->
<div id="Forecast" class="tabcontent">
  <h2>7-Day Weather Forecast</h2>
  <div id="tempChart"></div>
  <div id="cloudChart"></div>
  <div id="solarChart"></div>
</div>
<script>
    // --- 1. Global Helpers & Setup ---
    const params = new URLSearchParams(window.location.search);
    let bldg = params.get("bldg") || "7352";

    function parseHeaderDate(s) {
        const parts = s.split("/");
        if (parts.length === 3) {
            const [m, d, y] = parts.map(p => parseInt(p, 10));
            return new Date(y, m - 1, d);
        }
        return new Date(s);
    }

    function calculateCost(kwh, dateStr) {
        if (!kwh || kwh <= 0) return 0;
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return 0;

        const year = dateObj.getFullYear();
        const month = dateObj.getMonth() + 1;
        const numDays = new Date(year, month, 0).getDate();
        const basicCharge = 0.4603 * numDays;
        const isSummer = [6, 7, 8, 9].includes(month);

        let energyCharge = 0;
        if (isSummer) {
            if (kwh <= 650) energyCharge = kwh * 0.086;
            else if (kwh <= 1000) energyCharge = (650 * 0.086) + ((kwh - 650) * 0.143);
            else energyCharge = (650 * 0.086) + (350 * 0.143) + ((kwh - 1000) * 0.148);
        } else {
            energyCharge = kwh * 0.081;
        }

        const subtotal = basicCharge + energyCharge;
        const eccr = kwh * 0.0145;
        const mff = (subtotal + eccr) * 0.030674;
        const salesTax = (subtotal + eccr + mff) * 0.089;
        return Math.round((subtotal + eccr + mff + salesTax) * 100) / 100;
    }

    function safePlot(divId, data, layout) {
        const div = document.getElementById(divId);
        div.style.display = "block";
        div.innerHTML = "";
        if (!data || data.length === 0 || data.every(t => !t.y || t.y.length === 0)) {
            div.style.display = "none";
        } else {
            Plotly.newPlot(divId, data, layout, {responsive: true});
        }
    }

    // --- 2. Independent Chart Loaders (Hourly, DayOfWeek, Info, MonthlyCost) ---
    function drawHourlyChart(homeId) {
        d3.csv("HourlyEnergy.csv").then(rows => {
            const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
            const hours = filtered.map(r => +r.hour);
            const values = filtered.map(r => +r.grid);
            
            // Community Avg
            const grouped = d3.nest().key(d => +d.hour).rollup(v => d3.mean(v, d => +d.grid)).entries(rows);
            const avgHours = grouped.map(d => d.key);
            const avgValues = grouped.map(d => d.value);

            safePlot("hourlyChart", [
                { x: hours, y: values, type: "scatter", mode: "lines+markers", text: values.map(v => v.toFixed(1) + " kWh"), textposition: "top center", line: { color: "#1f77b4", width: 2 }, name: "Home " + homeId },
                { x: avgHours, y: avgValues, type: "scatter", mode: "lines", line: { color: "orange", dash: "dot" }, name: "Community Average" }
            ], { title: "Hourly Energy Use (24 Hours)", xaxis: { title: "Hour", range: [0, 23] }, yaxis: { title: "kWh" } });
        });
    }

    function drawDayOfWeekChart(homeId) {
        d3.csv("DayOfWeek.csv").then(rows => {
            const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
            const dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
            const days = filtered.map(r => dayNames[+r.day_of_week]);
            const values = filtered.map(r => +r.grid);
            
            const grouped = d3.nest().key(d => +d.day_of_week).rollup(v => d3.mean(v, d => +d.grid)).entries(rows);
            const avgValues = grouped.map(d => d.value);

            safePlot("dayOfWeekChart", [
                { x: dayNames, y: values, type: "bar", text: values.map(v => v.toFixed(1)), textposition: "outside", marker: { color: "#2ca02c" }, name: "Home " + homeId },
                { x: dayNames, y: avgValues, type: "bar", text: avgValues.map(v => v.toFixed(1)), textposition: "outside", marker: { color: "orange" }, name: "Community Average" }
            ], { title: "Average Daily Use by Day of Week", barmode: "group", yaxis: { title: "kWh" } });
        });
    }

    function drawHomeInfo(homeId) {
        d3.csv("PropertyData.csv").then(rows => {
            const row = rows.find(r => Number(r["dataid"]) === Number(homeId));
            const card = document.getElementById("homeInfoCard");
            if (!row) { card.innerHTML = "No info available."; return; }
            
            const infoItems = [
                { icon: "ðŸ ", label: "Exterior Wall", value: row["Exterior Wall"] },
                { icon: "ðŸ“…", label: "Year Built", value: row["Year Built"] },
                { icon: "ðŸ“", label: "Sq Ft", value: row["Res Sq Ft"] },
                { icon: "ðŸ›ï¸", label: "Bedrooms", value: row["Bedrooms"] },
                { icon: "ðŸ”¥", label: "Heating", value: row["Heating System"] },
                { icon: "ðŸ’²", label: "Value", value: row["Assessed Value"] }
            ];
            card.innerHTML = infoItems.map(i => `<div class="icon">${i.icon}</div><div><span class="label">${i.label}:</span> ${i.value}</div>`).join("");
        });
    }

    function drawMonthlyCostChart(homeId) { // Tab 2 Line Chart
        d3.csv("EnergyCost.csv").then(data => {
            const row = data.find(r => r.dataid === homeId);
            if(!row) return;
            const months = Object.keys(row).filter(k => k !== "dataid");
            const values = months.map(m => +row[m]);
            const avgValues = months.map(m => d3.mean(data.map(r => +r[m]).filter(v => !isNaN(v))));

            safePlot("monthlyCostChart", [
                { x: months, y: values, type: "scatter", mode: "lines+markers", name: "Home " + homeId, marker: { color: "#1f77b4" } },
                { x: months, y: avgValues, type: "scatter", mode: "lines", name: "Community Avg", line: { color: "orange" } }
            ], { title: "Monthly Cost Trend", yaxis: { title: "$" } });
        });
    }

    // --- 3. Main Data Block (Monthly + Seasonal + Savings) ---
    d3.csv("MonthlyEnergy_28days.csv").then(function(monthlyData) {
        const headers = monthlyData.columns;
        const dateCols = headers.slice(1);
        
        // Compute Community Average
        const avgByMonth = {};
        dateCols.forEach(col => {
            const vals = monthlyData.map(r => +r[col]).filter(v => v > 0);
            if (vals.length) avgByMonth[col] = d3.mean(vals);
        });

        // Populate Dropdowns
        const selectEl = document.getElementById("homeSelect");
        const selectCost = document.getElementById("homeSelectCost");
        monthlyData.forEach(d => {
            if(d.dataid) {
                selectEl.add(new Option(d.dataid, d.dataid));
                selectCost.add(new Option(d.dataid, d.dataid));
            }
        });

        // Function: Draw Main Usage Chart (Tab 2)
        function drawMainChart(homeId) {
            const row = monthlyData.find(d => d.dataid == homeId);
            if (!row) { document.getElementById("msg").innerText = "No data"; return; }
            
            const x = [], y = [];
            dateCols.forEach(col => { if(row[col]) { x.push(parseHeaderDate(col)); y.push(+row[col]); } });
            
            const avgX = [], avgY = [];
            dateCols.forEach(col => { if(avgByMonth[col]) { avgX.push(parseHeaderDate(col)); avgY.push(avgByMonth[col]); } });

            safePlot("chart", [
                { x: x, y: y, type: "scatter", mode: "lines+markers", name: "Home " + homeId },
                { x: avgX, y: avgY, type: "scatter", mode: "lines", name: "Community Avg", line: { color: "red", dash: "dot" } }
            ], { title: "Total Energy Consumption", xaxis: {type: "date"}, yaxis: {title: "kWh"}, legend: {x: 1, y: 1} });
        }

        // Function: Draw Cost Chart (Tab 3)
        function drawCostChart(homeId) {
            const row = monthlyData.find(d => d.dataid == homeId);
            if (!row) return;
            
            const months = dateCols.filter(m => +row[m] > 0);
            const costVals = months.map(m => calculateCost(+row[m], m));
            const commVals = months.map(m => calculateCost(avgByMonth[m], m));
            
            safePlot("costChart", [
                { x: months, y: costVals, type: "scatter", mode: "lines+markers+text", text: costVals.map(v=>"$"+Math.round(v)), textposition:"top center", name: "Home "+homeId, line:{color:"#1f77b4"} },
                { x: months, y: commVals, type: "scatter", mode: "lines", name: "Comm. Avg", line:{color:"red", dash:"dot"} }
            ], { title: "Estimated Monthly Energy Cost", template: "simple_white", yaxis: {title:"$"} });
        }

        // --- Seasonal & Savings Logic ---
        Promise.all([
            d3.csv("Category_SummerDailyAvg.csv"),
            d3.csv("Category_WinterDailyAvg.csv"),
            d3.csv("Category_SpringDailyAvg.csv"),
            d3.csv("Category_FallDailyAvg.csv")
        ]).then(([summer, winter, spring, fall]) => {
            
            // Helper: Season Charts
            function prepPercent(row, dataset) {
                if (!row) return [];
                const cats = ["HVAC","Water_Heating_Pumps","Kitchen_Refrigeration","Laundry","Lighting_Plugs_Rooms"];
                const vals = cats.map(k => +row[k] || 0);
                const total = d3.sum(vals);
                return total ? cats.map((k, i) => ({ cat: k, val: (vals[i]/total)*100 })) : [];
            }

            // Function: Draw Season Charts (Tab 2)
            function drawSeasonCharts(homeId) {
                const sRow = summer.find(d => d.dataid == homeId);
                const wRow = winter.find(d => d.dataid == homeId);
                const sData = prepPercent(sRow, summer);
                const wData = prepPercent(wRow, winter);
                
                safePlot("summerChart", [{x: sData.map(d=>d.cat), y: sData.map(d=>d.val), type:"bar", text:sData.map(d=>d.val.toFixed(1)+"%")}], {title:"Summer Breakdown", yaxis:{title:"%"}});
                safePlot("winterChart", [{x: wData.map(d=>d.cat), y: wData.map(d=>d.val), type:"bar", text:wData.map(d=>d.val.toFixed(1)+"%")}], {title:"Winter Breakdown", yaxis:{title:"%"}});
            }

            // Function: Savings Calculator (Tab 3)
            function drawSavingsCalculator(homeId) {
                const seasons = { 'summer': summer, 'winter': winter, 'spring': spring, 'fall': fall };
                const getSeasonName = m => [6,7,8].includes(m)?'summer':[12,1,2].includes(m)?'winter':[3,4,5].includes(m)?'spring':'fall';
                const cats = ["HVAC", "Water_Heating_Pumps", "Kitchen_Refrigeration", "Laundry", "Lighting_Plugs_Rooms"];
                const prettyCats = {"HVAC":"HVAC", "Water_Heating_Pumps":"Water Heating", "Kitchen_Refrigeration":"Kitchen", "Laundry":"Laundry", "Lighting_Plugs_Rooms":"Lights"};

                // 1. Calc Baseline
                const homeRow = monthlyData.find(d => d.dataid == homeId);
                if(!homeRow) return;
                
                const baselineCosts = { "HVAC":0, "Water_Heating_Pumps":0, "Kitchen_Refrigeration":0, "Laundry":0, "Lighting_Plugs_Rooms":0 };
                let totalBill = 0, count = 0;

                dateCols.forEach(dateStr => {
                    const kwh = +homeRow[dateStr];
                    if(kwh > 0) {
                        const bill = calculateCost(kwh, dateStr);
                        const dObj = new Date(dateStr);
                        if(!isNaN(dObj.getTime())) {
                            const sName = getSeasonName(dObj.getMonth()+1);
                            const sRow = seasons[sName].find(d => d.dataid == homeId);
                            if(sRow) {
                                const pcts = prepPercent(sRow); // Returns array of objects {cat, val}
                                const pctMap = {}; pcts.forEach(p => pctMap[p.cat] = p.val/100);
                                cats.forEach(c => baselineCosts[c] += bill * (pctMap[c]||0));
                                totalBill += bill;
                                count++;
                            }
                        }
                    }
                });

                if(count === 0) { document.getElementById("sliderContainer").innerHTML = "No Data"; return; }
                cats.forEach(c => baselineCosts[c] /= count);
                const avgBill = totalBill / count;

                // 2. Render Sliders
                const container = document.getElementById("sliderContainer");
                container.innerHTML = "";
                const sliderState = {}; cats.forEach(c => sliderState[c] = 0);

                cats.forEach(cat => {
                    const div = document.createElement("div");
                    div.innerHTML = `<div style="display:flex; justify-content:space-between"><b>${prettyCats[cat]}</b><span id="lbl_${cat}" style="color:blue">0%</span></div>`;
                    const input = document.createElement("input");
                    input.type = "range"; input.min = 0; input.max = 50; input.value = 0; input.style.width="100%"; input.className="savings-slider";
                    input.oninput = function() {
                        document.getElementById("lbl_"+cat).innerText = "-" + this.value + "%";
                        sliderState[cat] = this.value / 100;
                        updateCalc();
                    };
                    div.appendChild(input); container.appendChild(div);
                });

                // 3. Update Chart
                function updateCalc() {
                    let newBill = 0;
                    cats.forEach(c => {
                        const cost = baselineCosts[c];
                        const saved = cost * sliderState[c];
                        newBill += (cost - saved);
                    });
                    const saved = avgBill - newBill;
                    document.getElementById("savingsBigNumber").innerHTML = `Estimated Savings: <b>$${saved.toFixed(2)}</b>`;
                    safePlot("savingsResultChart", [
                        { x: ["Avg Bill"], y: [avgBill], type: "bar", name: "Current" },
                        { x: ["Avg Bill"], y: [newBill], type: "bar", name: "Projected" }
                    ], { title: "Bill Comparison", barmode: "group", showlegend:true });
                }
                updateCalc();
            }
            window.resetSliders = function() { document.querySelectorAll(".savings-slider").forEach(s => { s.value=0; s.dispatchEvent(new Event('input')); }); };

            // --- MASTER UPDATE FUNCTION ---
            window.updateAllCharts = function(id) {
                // Sync Dropdowns
                selectEl.value = id;
                selectCost.value = id;
                
                // Tab 2
                drawMainChart(id);
                drawMonthlyCostChart(id);
                drawSeasonCharts(id);
                drawHourlyChart(id);
                drawDayOfWeekChart(id);
                
                // Tab 1
                drawHomeInfo(id);
                
                // Tab 3
                drawCostChart(id);
                drawSavingsCalculator(id);
            };

            // Listeners
            selectEl.addEventListener("change", (e) => updateAllCharts(e.target.value));
            selectCost.addEventListener("change", (e) => updateAllCharts(e.target.value));

            // Initial Load
            updateAllCharts(bldg);

        }); // End Promise.all
    }); // End d3.csv

    // --- 4. Tab & Forecast Logic ---
    function openTab(evt, tabName) {
        document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
        document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }
    document.getElementById("defaultOpen").click();

    function loadForecast() {
        fetch("https://api.open-meteo.com/v1/forecast?latitude=33.749&longitude=-84.388&hourly=temperature_2m,apparent_temperature,cloudcover,shortwave_radiation&timezone=America/New_York")
        .then(res => res.json()).then(data => {
            const times = data.hourly.time;
            const temp = data.hourly.temperature_2m;
            const appTemp = data.hourly.apparent_temperature;
            const cloud = data.hourly.cloudcover;
            const solar = data.hourly.shortwave_radiation;

            const cz = { type: "rect", xref: "x", yref: "y", x0: times[0], x1: times[times.length-1], y0: 20, y1: 26, fillcolor: "rgba(0,200,0,0.1)", line: {width:0}, layer: "below" };
            
            safePlot("tempChart", [
                { x: times, y: temp, name: "Air Temp", line: {color: "red"} },
                { x: times, y: appTemp, name: "Feels Like", line: {color: "orange", dash: "dot"} }
            ], { title: "Temperature Forecast", shapes: [cz] });

            safePlot("cloudChart", [{ x: times, y: cloud, fill: "tozeroy", name: "Cloud %" }], { title: "Cloud Cover" });
            safePlot("solarChart", [{ x: times, y: solar, fill: "tozeroy", name: "Solar Rad", line: {color: "gold"} }], { title: "Solar Radiation" });
        });
    }
    document.querySelector("button[onclick*='Forecast']").addEventListener("click", loadForecast);
</script>
</body>
</html>
