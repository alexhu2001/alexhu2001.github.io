<!DOCTYPE html>
<html lang="en">
<head>
<style>
  .tab { overflow: hidden; border-bottom: 1px solid #ccc; }
  .tab button { background: none; border: none; padding: 10px 16px; cursor: pointer; }
  .tab button.active { background: #ccc; }
  .tabcontent { display: none; padding: 16px; }
  .info-card {
  display: grid;
  grid-template-columns: 40px auto;
  gap: 10px 15px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  max-width: 400px;
  background: #fafafa;
  font-family: sans-serif;
}
.info-card .icon {
  font-size: 1.2em;
  text-align: center;
}
.info-card .label {
  font-weight: bold;
}
</style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
<!-- Tab buttons -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Info')">Info</button>
  <button class="tablinks" onclick="openTab(event, 'Dashboard')" id="defaultOpen">Energy Usage</button>
  <button class="tablinks" onclick="openTab(event, 'Cost')">Energy Cost Analysis</button>
  <button class="tablinks" onclick="openTab(event, 'Forecast')">Weather Forecast</button>
</div>
<!-- Dashboard tab -->
<div id="Dashboard" class="tabcontent">
  <h2 id="title">Energy Usage Analysis</h2>
  <label for="homeSelect">Select Home:</label>
  <select id="homeSelect"></select>
  <div id="chart"></div>
  <div id="msg" style="color:red;"></div>
  <h2 id="titleCost">Monthly Energy Cost</h2>
  <div id="monthlyCostChart"></div>
  <!-- ===== Winter/Summer Comparison Section START ===== -->
  <hr>
  <h2 id="title2">Seasonal Energy Usage Breakdown by Category (%)</h2>
  <div id="summerChart"></div>
  <div id="winterChart"></div>
  <!-- ===== Winter/Summer Comparison Section END ===== -->
  <hr>
  <h2 id="titleHourly">Hourly Energy Use (24 Hours)</h2>
  <div id="hourlyChart"></div>
  <hr>
  <h2 id="titleDayOfWeek">Average Energy Use by Day of Week</h2>
  <div id="dayOfWeekChart"></div>
</div>
<!-- ===== Energy Cost Tab ===== -->
<div id="Cost" class="tabcontent">
    <h2>Estimated Monthly Energy Cost</h2>
    <p style="max-width:800px;">
        These cost estimates are based on Georgia Powerâ€™s standard residential rates. 
        The calculation includes the basic service fee, energy charges, and required 
        city and state fees. This gives families a simple way to understand what their 
        electricity use might cost each month.
    </p>
    
    <label for="homeSelectCost">Select Home:</label>
    <select id="homeSelectCost"></select>
    
    <div id="costChart"></div>

    <hr style="margin-top: 40px; border-top: 1px solid #ddd;">
    <h2 style="margin-top: 20px;">Targeted Savings Calculator</h2>
    <p style="max-width: 800px; color: #555;">
        Adjust the sliders below to simulate reducing your usage in specific categories.
        The chart below shows your <strong>projected monthly bill</strong> compared to your current bill.
    </p>

    <div class="savings-dashboard" style="display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px;">
        <div class="controls-card" style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 25px; border-radius: 8px; border: 1px solid #e9ecef;">
            <h3 style="margin-top: 0; font-size: 1.1em; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                Reduce Usage By...
            </h3>
            <div id="sliderContainer">
                <p>Loading home data...</p>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="resetSliders()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reset All
                </button>
            </div>
        </div>

        <div class="results-card" style="flex: 1.5; min-width: 400px; display: flex; flex-direction: column;">
            <div id="savingsResultChart" style="height: 400px;"></div>
            <div id="savingsBigNumber" style="text-align: center; margin-top: 10px; padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                Estimated Total Savings: <strong>$0.00</strong>
            </div>
        </div>
    </div>
</div>
<!-- Info tab -->
<div id="Info" class="tabcontent">
  <h2>About</h2>
  <p>This dashboard was created as part of a collaborative effort between researchers and community partners to transform energy data into meaningful insights that directly benefit local residents. By integrating household consumption records with seasonal, hourly, and dayâ€‘ofâ€‘week analyses, as well as weather forecasts and property characteristics, the tool provides a multiâ€‘layered understanding of how and when energy is used. Beyond simply tracking numbers, it highlights patterns, trends, and key drivers of demand, helping to establish a baseline for understanding household energy behavior. These findings are intended to support equitable and sustainable energy solutions by reducing costs, alleviating energy burdens, and empowering disadvantaged communities with knowledge that can inform both individual decisions and broader policy initiatives.</p>
  <div id="homeInfoCard" class="info-card"></div>
</div>
<!-- Forecast tab -->
<div id="Forecast" class="tabcontent">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>7-Day Weather Forecast</h2>
    <button id="weatherToggleBtn" onclick="toggleWeatherUnit()" style="padding:8px 16px; cursor:pointer; font-weight:bold; border-radius:4px; border:1px solid #ccc;">
      Switch to Â°C
    </button>
  </div>
  <div id="tempChart"></div>
  <div id="cloudChart"></div>
  <div id="solarChart"></div>
</div>
<script>
    // === 1. GLOBAL CONFIGURATION ===
    const ID_MAP = {
        "2005": "1", "2462": "2", "2542": "3", "2933": "4", "3485": "5",
        "3841": "6", "4399": "7", "5265": "8", "7246": "9", "7352": "10",
        "7624": "11", "9765": "12", "9783": "13", "10323": "14", "10532": "15",
        "10686": "16", "11744": "17", "6820": "18", "10458": "19"
    };

    // === 2. MONKEY PATCH D3 (The Master Fix) ===
    // This intercepts ALL data loading to fix IDs and Dates globally
    const originalD3Csv = d3.csv;
    d3.csv = function(url, ...args) {
        return originalD3Csv(url, ...args).then(data => {
            
            // A. Fix Date Headers (Solves the "Nov 30" Issue)
            // We append " 12:00" to date columns so they are treated as Noon, not Midnight.
            if (data.columns && data.columns.length > 1) {
                // Assume columns after index 0 are dates (standard for your files)
                const oldCols = [...data.columns];
                const newCols = data.columns.map((col, i) => {
                    // if it contains a slash or dash, assume it's a date
                    if (i > 0 && (col.includes('/') || col.includes('-'))) {
                        return col + " 12:00"; // Force Noon
                    }
                    return col;
                });

                // Apply new headers to every row
                data.forEach(row => {
                    oldCols.forEach((oldKey, i) => {
                        if (oldKey !== newCols[i]) {
                            row[newCols[i]] = row[oldKey]; // Move data to new key
                            delete row[oldKey];            // Remove old key
                        }
                    });
                });
                data.columns = newCols; // Update column list
            }

            // B. Fix IDs (Old -> New)
            data.forEach(row => {
                if (row.dataid && ID_MAP[row.dataid]) {
                    row.dataid = ID_MAP[row.dataid];
                }
            });

            // C. Sort Numerically (1, 2, 3...)
            data.sort((a, b) => Number(a.dataid) - Number(b.dataid));

            return data;
        });
    };

    // Patch Plotly's D3 too (for charts that use it)
    if (window.Plotly && Plotly.d3) {
        const originalPlotlyCsv = Plotly.d3.csv;
        Plotly.d3.csv = function(url, callback) {
            originalPlotlyCsv(url, function(err, rows) {
                if (rows) {
                    rows.forEach(row => {
                        if (row.dataid && ID_MAP[row.dataid]) row.dataid = ID_MAP[row.dataid];
                    });
                    rows.sort((a, b) => Number(a.dataid) - Number(b.dataid));
                }
                callback(err, rows);
            });
        };
    }

    // === 3. SETUP & HELPERS ===
    const params = new URLSearchParams(window.location.search);
    let rawBldg = params.get("bldg") || "7352"; 
    let bldg = ID_MAP[rawBldg] || rawBldg;
    if (bldg === "7352") bldg = "10"; 

    // Robust Date Parser (Handles the new " 12:00" format)
    function parseHeaderDate(s) {
        // Just let the browser parse the "Date + 12:00" string we created
        return new Date(s); 
    }
// === Energy Cost Calculator (Atlanta version) ===
function calculateCost(kwh, dateStr) {
    if (!kwh || kwh <= 0) return 0;

    // FIX: Use standard Date parsing to handle "MM/DD/YYYY" (slashes) or "YYYY-MM-DD"
    const dateObj = new Date(dateStr);
    
    // Safety check if date is invalid
    if (isNaN(dateObj.getTime())) return 0;

    const year = dateObj.getFullYear();
    const month = dateObj.getMonth() + 1; // JS months are 0-11, we need 1-12
    const numDays = new Date(year, month, 0).getDate(); // Get last day of the specific month

    const basicCharge = 0.4603 * numDays;
    const isSummer = [6, 7, 8, 9].includes(month);

    let energyCharge = 0;
    if (isSummer) {
        if (kwh <= 650) {
            energyCharge = kwh * 0.086;
        } else if (kwh <= 1000) {
            energyCharge = (650 * 0.086) + ((kwh - 650) * 0.143);
        } else {
            energyCharge = (650 * 0.086) + (350 * 0.143) + ((kwh - 1000) * 0.148);
        }
    } else {
        energyCharge = kwh * 0.081;
    }

    const subtotal = basicCharge + energyCharge;
    const eccr = kwh * 0.0145;
    const mff = (subtotal + eccr) * 0.030674;
    const salesTax = (subtotal + eccr + mff) * 0.089;

    return Math.round((subtotal + eccr + mff + salesTax) * 100) / 100;
}
function drawCostChart(homeData, avgByMonth) {
    // 1. Safety Check: If data is missing, stop.
    if (!homeData || !avgByMonth) return;

    // 2. Filter Data: Only keep months where the Home has usage > 0
    const allMonths = Object.keys(homeData).filter(m => m !== "dataid");
    const validMonths = allMonths.filter(m => Number(homeData[m]) > 0);

    // If no valid data, clear the chart area safely
    if (validMonths.length === 0) {
        const chartDiv = document.getElementById('costChart');
        if (chartDiv) chartDiv.innerHTML = "No valid data to display.";
        return;
    }

    // 3. Calculate Costs
    const costValues = validMonths.map(m => calculateCost(Number(homeData[m]), m));
    
    // Safety check for community data: ensure the month exists in avgByMonth
    const commValues = validMonths.map(m => {
        const val = avgByMonth[m] !== undefined ? avgByMonth[m] : 0;
        return calculateCost(val, m);
    });

    // 4. Calculate Averages for Legend
    const getAvg = (arr) => arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2) : "0.00";
    const homeLegend = `Home ${homeData.dataid} (Avg: $${getAvg(costValues)})`;
    const commLegend = `Community Avg (Avg: $${getAvg(commValues)})`;

    // 5. Trace 1: Home (Blue Solid Line + Dots + Text Labels)
    // You requested Blue in your screenshot example, but Black in previous turn. 
    // I will use the Blue from your screenshot (image_03895f.png) as it matches the "Home" style better.
    const traceHome = {
        x: validMonths,
        y: costValues,
        type: 'scatter',
        mode: 'lines+markers+text',
        text: costValues.map(v => '$' + Math.round(v)),
        textposition: 'top center',
        name: homeLegend,
        line: { color: '#1f77b4', width: 2 }, // Standard Blue
        marker: { size: 8, color: '#1f77b4', symbol: 'circle' },
        textfont: { family: 'Arial', size: 12, color: '#1f77b4', weight: 'bold' }
    };

    // 6. Trace 2: Community (Red Dotted Line, No Labels)
    const traceAvg = {
        x: validMonths,
        y: commValues,
        type: 'scatter',
        mode: 'lines',
        name: commLegend,
        line: { color: 'red', width: 2, dash: 'dot' }
    };

    // 7. Layout: Clean Research Style
    const layout = {
        title: { text: 'Estimated Monthly Energy Cost', font: { family: 'Times New Roman', size: 24 } },
        template: 'simple_white',
        yaxis: { title: 'Cost ($)', showgrid: true, gridcolor: '#eee' },
        xaxis: { title: '', showgrid: false },
        legend: { x: 1, y: 1.1, xanchor: 'right', orientation: 'h' },
        margin: { t: 80, l: 60, r: 40, b: 60 },
        hovermode: 'x unified'
    };

    // FIX: Target 'costChart' (Tab 3) instead of 'monthlyCostChart'
    Plotly.newPlot('costChart', [traceHome, traceAvg], layout, {responsive: true});
}
//é€šç”¨ç»˜å›¾å‡½æ•°ï¼šæ— æ•°æ®åˆ™éšè—ï¼Œæœ‰æ•°æ®åˆ™ç»˜åˆ¶
function safePlot(divId, data, layout) {
  const div = document.getElementById(divId);
  // Always reset visibility before checking
  div.style.display = "block";
  div.innerHTML = ""; // clear any old content
  if (!data || data.length === 0 || data.every(t => !t.y || t.y.length === 0)) {
    div.style.display = "none";   // hide if no data
  } else {
    Plotly.newPlot(divId, data, layout, {responsive:true});
  }
}
    d3.csv("MonthlyEnergy_28days.csv").then(function(data) {
      const headers = data.columns;
      const dateCols = headers.slice(1);
      // Compute average for each month across all homes
      const avgByMonth = {};
      dateCols.forEach(col => {
        let vals = data
          .map(row => {
            const v = row[col];
            return (v && v.trim() !== "") ? +v : null;
          })
          .filter(v => v !== null && !isNaN(v));
        if (vals.length > 0) {
          avgByMonth[col] = d3.mean(vals);
        }
      });   
      // Populate dropdown
      const selectEl = document.getElementById("homeSelect");
      data.forEach(row => {
        const id = row["dataid"];
        if (id) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = id;
          selectEl.appendChild(opt);
        }
      });
// Populate cost tab dropdown
// --- CODE FOR COST SELECT (Tab 3) ---
    const homeSelectCost = document.getElementById("homeSelectCost");
    
    // Clear existing options first to avoid duplicates if re-run
    homeSelectCost.innerHTML = ""; 

    data.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.dataid;
        opt.textContent = d.dataid;
        homeSelectCost.appendChild(opt);
    });
    // INITIAL LOAD: Pass 'avgByMonth' as the second argument
    if (data.length > 0) {
        // Use 'bldg' global var or fallback to first
        const initialHome = data.find(d => d.dataid == bldg) || data[0];
        homeSelectCost.value = initialHome.dataid;
        
        drawCostChart(initialHome, avgByMonth);
    }
// Initial draw for the first home
if (data.length > 0) {
    const first = data[0];
    homeSelectCost.value = first.dataid;
    drawCostChart(first);
}
      selectEl.value = bldg;
      function drawChart(homeId) {
        const row = data.find(d => String(d["dataid"]).trim() === String(homeId));
        if (!row) {
          document.getElementById("msg").innerText = "No data for " + homeId;
          return;
        }
        const x = [], y = [];
        dateCols.forEach(col => {
          const val = row[col];
          if (val && val.trim() !== "") {
            x.push(parseHeaderDate(col));
            y.push(+val);
          }
        });
        if (x.length === 0) {
          document.getElementById("msg").innerText = "No values found for Home " + homeId;
          safePlot("chart", [], {});   // hide chart properly
          return;
        }
        const avgX = [], avgY = [];
        dateCols.forEach(col => {
          if (avgByMonth[col] !== undefined) {
            avgX.push(parseHeaderDate(col));
            avgY.push(avgByMonth[col]);
          }
        });
        const maxValHome = Math.max(...y);
        const maxValAvg = avgY.length > 0 ? Math.max(...avgY) : 0;
        const yMax = Math.max(maxValHome, maxValAvg) * 1.2;

        // --- Compute averages ---
        const homeAvg = d3.mean(y).toFixed(1);
        const commAvg = avgY.length > 0 ? d3.mean(avgY).toFixed(1) : "N/A";  
        safePlot("chart", [
          {
            x: x,
            y: y,
            type: "scatter",
            mode: "lines+markers",
            name: "Home " + homeId
          },
          {
            x: avgX,
            y: avgY,
            type: "scatter",
            mode: "lines",
            name: "Community Average",
            line: { color: "red", dash: "dot" }
          }
        ], {
          title: "Total Energy Consumption by Month for Home " + homeId,
          xaxis: { title: "Month", type: "date" },
          yaxis: { title: "kWh", range: [0, yMax] },
  // â¬‡ï¸ Add these lines inside the layout object
  legend: {
    x: 1.02,
    y: 1,
    xanchor: "left",
    yanchor: "top",
    orientation: "v"
  },
  margin: { r: 180, t: 50, b: 50, l: 60 },
  annotations: [
    {
      xref: "paper",
      yref: "paper",
      x: 1.02,
      y: 0.92,
      text: "Home Avg: " + homeAvg + " kWh/month",
      showarrow: false,
      align: "left"
    },
    {
      xref: "paper",
      yref: "paper",
      x: 1.02,
      y: 0.86,
      text: "Community Avg: " + commAvg + " kWh/month",
      showarrow: false,
      align: "left"
    }]
        });
      }
      // Initial draw
      drawChart(bldg);
      document.getElementById("msg").innerText = "";
      // Dropdown change
      selectEl.addEventListener("change", () => {
        const newId = selectEl.value;
        const url = new URL(window.location);
        url.searchParams.set("bldg", newId);
        window.history.replaceState({}, "", url);
        drawChart(newId);
      });
<!-- ===== Winter/Summer Comparison Code START ===== -->
Promise.all([
  d3.csv("Category_SummerDailyAvg.csv"),
  d3.csv("Category_WinterDailyAvg.csv")
]).then(([summer, winter]) => {
  function avgRow(data) {
    const result = {};
    data.columns.slice(1).forEach(col => {
      const vals = data.map(r => +r[col]).filter(v => v > 0);
      if (vals.length > 0) result[col] = d3.mean(vals);
    });
    return result;
  }
  const sAvg = avgRow(summer);
  const wAvg = avgRow(winter);
function prepPercent(row, avg, labelHome, labelAvg) {
  if (!row) return [];
  const entries = Object.keys(row)
    .filter(k => k !== "dataid" && +row[k] > 0)
    .map(k => ({ cat: k, val: +row[k] }));
  const total = d3.sum(entries, d => d.val);
  const homeData = entries.map(d => ({
    cat: d.cat,
    val: d.val / total * 100,   // percentage
    raw: d.val,                 // actual kWh
    type: labelHome
  }));
  const avgEntries = Object.keys(avg)
    .filter(k => avg[k] > 0)
    .map(k => ({ cat: k, val: avg[k] }));
  const avgTotal = d3.sum(avgEntries, d => d.val);
  const avgData = avgEntries.map(d => ({
    cat: d.cat,
    val: d.val / avgTotal * 100,
    raw: d.val,
    type: labelAvg
  }));
  return [...homeData, ...avgData];
}
function makeTraces(data) {
  const types = [...new Set(data.map(d => d.type))];
  return types.map(t => {
    const filtered = data.filter(d => d.type === t);
    return {
      x: filtered.map(d => d.cat),
      y: filtered.map(d => d.val),
      name: t,
      type: "bar",
      text: filtered.map(d => d.val.toFixed(1) + "%"),
//      text: filtered.map(d => d.val.toFixed(1) + "% (" + d.raw.toFixed(1) + " kWh)"),
      textposition: "outside"
    };
  });
}
// Keep hourly at top-level inside this Promise block
function drawHourlyChart(homeId) {
  Plotly.d3.csv("HourlyEnergy.csv", function(err, rows) {
    if (err) {
      console.error("Error loading HourlyEnergy.csv:", err);
      return;
    }
    const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
    const hours = filtered.map(r => +r.hour);
    const values = filtered.map(r => +r.grid);
// --- Community average across all homes ---
const grouped = d3.nest()
  .key(d => +d.hour)
  .rollup(v => d3.mean(v, d => +d.grid))
  .entries(rows);
const avgHours = grouped.map(d => d.key);
const avgValues = grouped.map(d => d.value);
const traceAvg = {
  x: avgHours, y: avgValues, type: "scatter", mode: "lines",
  line: { color: "orange", dash: "dot" },
  name: "Community Average"
};
    const trace = {
  x: hours,
  y: values,
  type: "scatter",
  mode: "lines+markers",   // add text labels
  text: values.map(v => v.toFixed(1) + " kWh"), // label each point
  textposition: "top center",
  line: { color: "#1f77b4", width: 2 },
  marker: { size: 6 },
  name: "Home " + homeId
};
    const layout = {
      title: "Hourly Energy Use for Home " + homeId,
      xaxis: {title: "Hour of Day", tickmode: "linear", dtick: 1, range: [0, 23]},
      yaxis: {title: "Energy Use (kWh)"}
    };
    safePlot("hourlyChart", [trace, traceAvg], layout);
  });
}
// ===== Day of Week chart =====
function drawDayOfWeekChart(homeId) {
  Plotly.d3.csv("DayOfWeek.csv", function(err, rows) {
    if (err) {
      console.error("Error loading DayOfWeek.csv:", err);
      return;
    }
    // Filter for the selected home
    const filtered = rows.filter(r => Number(r.dataid) === Number(homeId));
    // Map day numbers to names
    const dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
    const days = filtered.map(r => dayNames[+r.day_of_week]);
    const values = filtered.map(r => +r.grid);
    // --- Community average across all homes ---
    const grouped = d3.nest()
      .key(d => +d.day_of_week)
      .rollup(v => d3.mean(v, d => +d.grid))
      .entries(rows);
    const avgDays = grouped.map(d => dayNames[d.key]);
    const avgValues = grouped.map(d => d.value);
    // --- Traces ---
    const traceHome = {
      x: days,
      y: values,
      type: "bar",
      text: values.map(v => v.toFixed(1) + " kWh"), // labels above bars
      textposition: "outside",
      marker: { color: "#2ca02c" },
      name: "Home " + homeId
    };
    const traceAvg = {
      x: avgDays,
      y: avgValues,
      type: "bar",
      text: avgValues.map(v => v.toFixed(1) + " kWh"),
      textposition: "outside",
      marker: { color: "orange" },
      name: "Community Average"
    };
    const layout = {
      barmode: "group",
      title: "Average Daily Energy Use by Day of Week for Home " + homeId,
      xaxis: { title: "Day of Week" },
      yaxis: { title: "Energy Use (kWh)" }
    };
    safePlot("dayOfWeekChart", [traceHome, traceAvg], layout);
  });
}
// ===== Home Info card =====
function drawHomeInfo(homeId) {
  d3.csv("PropertyData.csv").then(rows => {
    const row = rows.find(r => Number(r["dataid"]) === Number(homeId));
    if (!row) {
      document.getElementById("homeInfoCard").innerHTML = "No info available.";
      return;
    }
    const infoItems = [
      { icon: "ðŸ ", label: "Exterior Wall", value: row["Exterior Wall"] },
      { icon: "ðŸ“…", label: "Year Built", value: row["Year Built"] },
      { icon: "ðŸ“", label: "Sq Ft", value: row["Res Sq Ft"] },
      { icon: "ðŸ›ï¸", label: "Bedrooms", value: row["Bedrooms"] },
      { icon: "ðŸ”¥", label: "Heating System", value: row["Heating System"] },
      { icon: "ðŸ’¨", label: "Heat", value: row["Heat"] },
      { icon: "ðŸ“Š", label: "Grade Factor", value: row["Grade Factor"] },
      { icon: "ðŸ’²", label: "Assessed Value", value: row["Assessed Value"] }
    ];
    const html = infoItems.map(item => `
      <div class="icon">${item.icon}</div>
      <div><span class="label">${item.label}:</span> ${item.value}</div>
    `).join("");
    document.getElementById("homeInfoCard").innerHTML = html;
  });
}
function drawMonthlyCostChart(homeId) {
  d3.csv("EnergyCost.csv").then(costData => {
    const row = costData.find(r => r.dataid === homeId);
    if (!row) {
      document.getElementById("monthlyCostChart").innerHTML = "No cost data available.";
      return;
    }
    const months = Object.keys(row).filter(k => k !== "dataid");
    const values = months.map(m => row[m] ? +row[m] : null);
    // ç¤¾åŒºå¹³å‡
const avgValues = months.map(m => {
  const nums = costData
    .map(r => r[m] ? +r[m] : NaN)   // convert only if not empty
    .filter(v => !isNaN(v));        // drop NaN values
  return nums.length ? d3.mean(nums) : null;
    });
    const traceHome = {
      x: months,
      y: values,
      type: "scatter",
      mode: "lines+markers",
      name: "Home " + homeId,
      marker: { color: "#1f77b4", width: 2 }
    };
    const traceAvg = {
      x: months,
      y: avgValues,
      type: "scatter",
      mode: "lines+markers",
      name: "Community Average",
      line: { color: "orange", width: 2 }
    };
    const layout = {
      barmode: "group",
      yaxis: { title: "Monthly Cost ($)" },
      margin: { t: 30 }
    };
    Plotly.newPlot("monthlyCostChart", [traceHome, traceAvg], layout, {responsive: true});
  });
}
  // The ONLY seasonal function â€” do not redefine it later
  function drawSeasonCharts(homeId) {
    document.getElementById("msg").innerText = "";
    const sRow = summer.find(d => String(d.dataid).trim() === String(homeId).trim());
    const wRow = winter.find(d => String(d.dataid).trim() === String(homeId).trim());
    const summerData = sRow ? prepPercent(sRow, sAvg, "Home " + homeId, "Community Average") : [];
    const winterData = wRow ? prepPercent(wRow, wAvg, "Home " + homeId, "Community Average") : [];
    const maxValS = d3.max(summerData, d => d.val) || 0;
    const maxValW = d3.max(winterData, d => d.val) || 0;
    safePlot("summerChart", makeTraces(summerData), {
      barmode: "group",
      title: "Summer (June-Aug) Energy Usage Distribution by Category for Home " + homeId,
      yaxis: { title: "% of total household energy use", range: [0, maxValS * 1.2] },
      xaxis: { title: "Category" }
    });
    safePlot("winterChart", makeTraces(winterData), {
      barmode: "group",
      title: "Winter (Dec-Feb) Energy Usage Distribution by Category for Home " + homeId,
      yaxis: { title: "% of total household energy use", range: [0, maxValW * 1.2] },
      xaxis: { title: "Category" }
    });
  }
// ============================================================
//  UNIFIED MASTER UPDATE HANDLER (Syncs Tabs 1, 2, 3, 4)
// ============================================================
const usageSelect = document.getElementById("homeSelect");
const costSelect = document.getElementById("homeSelectCost");

function handleGlobalChange(newId) {
    // 1. Sync Visuals (Dropdowns & URL)
    if (usageSelect.value !== newId) usageSelect.value = newId;
    if (costSelect.value !== newId) costSelect.value = newId;
    
    const url = new URL(window.location);
    url.searchParams.set("bldg", newId);
    window.history.replaceState({}, "", url);

    // 2. Update TAB 2 (Energy Usage)
    drawChart(newId);
    drawMonthlyCostChart(newId);
    drawSeasonCharts(newId);
    drawHourlyChart(newId);
    drawDayOfWeekChart(newId);

    // 3. Update TAB 1 (Info)
    drawHomeInfo(newId);

    // 4. Update TAB 3 (Cost & Savings)
    // Note: Cost chart needs the specific row object, not just ID
    const selectedData = data.find(d => d.dataid == newId);
    if (selectedData) {
        drawCostChart(selectedData, avgByMonth);
        if (window.drawSavingsCalculator) {
            window.drawSavingsCalculator(newId);
        }
    }
}

// Attach the Master Handler to BOTH dropdowns
usageSelect.addEventListener("change", (e) => handleGlobalChange(e.target.value));
costSelect.addEventListener("change", (e) => handleGlobalChange(e.target.value));

// Initial Load (Draws everything at once)
if (data.find(d => d.dataid === bldg)) {
    handleGlobalChange(bldg);
}
// ============================================================
    //  NEW: Savings Calculator Logic (Appended Safely)
    // ============================================================
    
    // 1. Load Seasonal Data
    Promise.all([
        d3.csv("Category_SummerDailyAvg.csv"),
        d3.csv("Category_WinterDailyAvg.csv"),
        d3.csv("Category_SpringDailyAvg.csv"),
        d3.csv("Category_FallDailyAvg.csv")
    ]).then(([summer, winter, spring, fall]) => {
        
        const seasons = { 'summer': summer, 'winter': winter, 'spring': spring, 'fall': fall };
        const getSeasonName = m => [6,7,8].includes(m)?'summer':[12,1,2].includes(m)?'winter':[3,4,5].includes(m)?'spring':'fall';
        
        // Helper: Calculate Category Breakdown (%)
        function getSeasonPcts(homeId, seasonName) {
            const row = seasons[seasonName].find(d => d.dataid == homeId);
            if (!row) return null;
            const cats = ["HVAC","Water_Heating_Pumps","Kitchen_Refrigeration","Laundry","Lighting_Plugs_Rooms"];
            let total = 0;
            const vals = {};
            cats.forEach(c => {
                const v = parseFloat(row[c]) || 0;
                vals[c] = v;
                total += v;
            });
            if (total === 0) return null;
            const pcts = {};
            cats.forEach(c => pcts[c] = vals[c] / total);
            return pcts;
        }

        // Main Draw Function
        window.drawSavingsCalculator = function(homeId) {
            const container = document.getElementById("sliderContainer");
            if (!container) return;
            container.innerHTML = "";
            
            const homeRow = data.find(d => d.dataid == homeId);
            if (!homeRow) { container.innerHTML = "No data found."; return; }

            const cats = ["HVAC", "Water_Heating_Pumps", "Kitchen_Refrigeration", "Laundry", "Lighting_Plugs_Rooms"];
            const prettyCats = { "HVAC":"Heating & AC", "Water_Heating_Pumps":"Water Heating", "Kitchen_Refrigeration":"Kitchen & Fridge", "Laundry":"Laundry", "Lighting_Plugs_Rooms":"Lights & Plugs" };
            const sliderState = {}; 
            cats.forEach(c => sliderState[c] = 0);

            // A. Create Sliders
            cats.forEach(cat => {
                const div = document.createElement("div");
                div.style.marginBottom = "15px";
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-weight:bold; font-size:0.9em;">${prettyCats[cat]}</span>
                        <span id="lbl_${cat}" style="color:#007bff; font-weight:bold;">0%</span>
                    </div>`;
                const input = document.createElement("input");
                input.type = "range"; input.min = 0; input.max = 50; input.step = 5; input.value = 0;
                input.className = "savings-slider"; input.style.width = "100%";
                input.oninput = function() {
                    document.getElementById("lbl_"+cat).innerText = "-" + this.value + "%";
                    sliderState[cat] = this.value / 100;
                    updateProjectedChart();
                };
                div.appendChild(input); container.appendChild(div);
            });

            // B. Chart Update Function
            function updateProjectedChart() {
                const months = dateCols.filter(m => homeRow[m] && +homeRow[m] > 0);
                const currCosts = [], projCosts = [];
                let totalSavings = 0;

                months.forEach(m => {
                    const kwh = parseFloat(homeRow[m]);
                    const currBill = calculateCost(kwh, m);
                    const dObj = new Date(m);
                    const season = getSeasonName(dObj.getMonth() + 1);
                    const pcts = getSeasonPcts(homeId, season);

                    let savedKwh = 0;
                    if (pcts) {
                        cats.forEach(c => {
                            const catKwh = kwh * pcts[c];
                            savedKwh += catKwh * sliderState[c];
                        });
                    }
                    const newBill = calculateCost(kwh - savedKwh, m);
                    currCosts.push(currBill);
                    projCosts.push(newBill);
                    totalSavings += (currBill - newBill);
                });

                document.getElementById("savingsBigNumber").innerHTML = `Estimated Total Savings: <strong>$${totalSavings.toFixed(2)}</strong>`;
                
                Plotly.react("savingsResultChart", [
                    { x: months, y: currCosts, type: "scatter", mode: "lines+markers", name: "Current", line:{color:"#343a40", width:2} },
                    { x: months, y: projCosts, type: "scatter", mode: "lines+markers", name: "Projected", line:{color:"#28a745", width:2, dash:"dot"}, fill:"tonexty" }
                ], { 
                    title: "Projected Bill Savings", yaxis: {title:"Cost ($)"}, 
                    template: "simple_white", margin: {t:40, b:40, l:60, r:20}, legend: {orientation:"h", y:1.1}
                }, {displayModeBar: false});
            }
            updateProjectedChart();
        };

        // Reset Button Logic
        window.resetSliders = function() {
            document.querySelectorAll(".savings-slider").forEach(s => { s.value=0; s.dispatchEvent(new Event('input')); });
        };

        // Initialize Calculator
        if (typeof bldg !== 'undefined') drawSavingsCalculator(bldg);

        // Hook into Cost Dropdown
        const costSelect = document.getElementById("homeSelectCost");
        if(costSelect) {
            costSelect.addEventListener("change", function() {
                drawSavingsCalculator(this.value);
            });
        }
    });
}).catch(err => {
  document.getElementById("msg").innerText = "Error loading CSV: " + err;
  console.error(err);
});
    }).catch(err => {
      document.getElementById("msg").innerText = "Error loading CSV: " + err;
      console.error(err);
    });
// Tab switching with Auto-Resize Fix
function openTab(evt, tabName) {
  // 1. Standard Tab Logic
  document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
  document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.classList.add("active");

  // 2. FORCE RESIZE for all charts in the newly visible tab
  // This fixes the "squished" chart issue
  const visibleCharts = document.getElementById(tabName).querySelectorAll('.js-plotly-plot');
  visibleCharts.forEach(chartDiv => {
    Plotly.Plots.resize(chartDiv);
  });
}
// Open default tab
document.getElementById("defaultOpen").click();
// ===== Forecast Logic with Unit Toggle =====
let weatherUnit = 'fahrenheit'; // Default to Fahrenheit for Atlanta

function toggleWeatherUnit() {
  weatherUnit = (weatherUnit === 'fahrenheit') ? 'celsius' : 'fahrenheit';
  loadForecast(); // Reload data with new unit
}

function loadForecast() {
  const isF = (weatherUnit === 'fahrenheit');
  const unitUrl = isF ? "&temperature_unit=fahrenheit" : ""; // API defaults to Celsius if blank
  
  // 1. Update Button Text
  const btn = document.getElementById("weatherToggleBtn");
  if (btn) btn.innerText = isF ? "Switch to Â°C" : "Switch to Â°F";

  // 2. Fetch Data
  fetch("https://api.open-meteo.com/v1/forecast?latitude=33.749&longitude=-84.388&hourly=temperature_2m,apparent_temperature,cloudcover,shortwave_radiation&timezone=America/New_York" + unitUrl)
    .then(res => res.json())
    .then(data => {
      const times = data.hourly.time;
      const temp = data.hourly.temperature_2m;
      const appTemp = data.hourly.apparent_temperature;
      const cloud = data.hourly.cloudcover;
      const solar = data.hourly.shortwave_radiation;

      // 3. Define Dynamic Variables based on Unit
      const unitLabel = isF ? "Â°F" : "Â°C";
      const yMin = isF ? 68 : 20; // Comfort Zone Bottom
      const yMax = isF ? 79 : 26; // Comfort Zone Top
      const czLabel = isF ? "Comfort Zone (68Â°F - 79Â°F)" : "Comfort Zone (20Â°C - 26Â°C)";
      const czCenter = (yMin + yMax) / 2;

      // 4. Draw Temperature Chart
      const comfortZone = {
        type: "rect", xref: "x", yref: "y",
        x0: times[0], x1: times[times.length - 1],
        y0: yMin, y1: yMax,
        fillcolor: "rgba(0,200,0,0.1)", line: { width: 0 }, layer: "below"
      };

      Plotly.newPlot("tempChart", [
        { x: times, y: temp, type: "scatter", mode: "lines", name: `Air Temp (${unitLabel})`, line: { color: "red" } },
        { x: times, y: appTemp, type: "scatter", mode: "lines", name: `Feels Like (${unitLabel})`, line: { color: "orange", dash: "dot" } }
      ], {
        title: "Hourly Temperature vs. Apparent Temperature",
        xaxis: { title: "Time" },
        yaxis: { title: unitLabel },
        hovermode: "x unified",
        shapes: [comfortZone],
        annotations: [{
          xref: "paper", yref: "y", x: 1.02, y: czCenter,
          text: czLabel, showarrow: false,
          font: { color: "green" }
        }]
      }, {responsive: true});

      // 5. Draw Other Charts (Unchanged)
      Plotly.newPlot("cloudChart", [
        { x: times, y: cloud, type: "scatter", mode: "lines", name: "Cloud Cover (%)", line: { color: "gray" }, fill: "tozeroy", fillcolor: "rgba(128,128,128,0.3)" }
      ], { title: "Hourly Cloud Cover", xaxis: { title: "Time" }, yaxis: { title: "%" }, hovermode: "x unified" }, {responsive: true});

      Plotly.newPlot("solarChart", [
        { x: times, y: solar, type: "scatter", mode: "lines", name: "Solar Radiation (W/mÂ²)", line: { color: "gold" }, fill: "tozeroy", fillcolor: "rgba(255,215,0,0.3)" }
      ], { title: "Hourly Solar Radiation", xaxis: { title: "Time" }, yaxis: { title: "W/mÂ²" }, hovermode: "x unified" }, {responsive: true});
    });
}

// Hook forecast loader to Forecast tab button
const forecastTabBtn = document.querySelector("button[onclick*='Forecast']");
if(forecastTabBtn) forecastTabBtn.addEventListener("click", loadForecast);
    // Auto-resize charts when window size changes
window.addEventListener('resize', () => {
  document.querySelectorAll('.js-plotly-plot').forEach(chart => Plotly.Plots.resize(chart));
});
</script>
</body>
</html>
